<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­¤åˆ»åœ°å›¾ Ceshi 9.1.1</title>
    <style>

        /* ==================== é•¿æŒ‰åé¦ˆæ•ˆæœ ==================== */
        @keyframes longPressPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .marker-pressing {
            animation: longPressPulse 0.5s infinite;
        }

        /* é•¿æŒ‰æç¤º */
        .long-press-hint {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
            animation: fadeIn 0.3s;
        }

        /* ==================== ç§èŠæŒ‰é’®åŠ¨ç”»æ•ˆæœ ==================== */
        @keyframes chatButtonPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .chat-button-pulse {
            animation: chatButtonPulse 2s infinite;
        }

        @keyframes chatButtonShake {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-2px) rotate(-5deg); }
            50% { transform: translateY(-2px) rotate(5deg); }
            75% { transform: translateY(-2px) rotate(-5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .chat-button-shake {
            animation: chatButtonShake 0.5s ease-in-out;
        }



        /* ==================== å…¨å±€æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #021024;
            color: white;
            touch-action: pan-x pan-y;
        }

        /* ==================== ç™»å½•æ³¨å†Œç•Œé¢æ ·å¼ ==================== */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 5px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            color: #333;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder {
            color: #999;
        }

        .form-hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .form-error {
            font-size: 12px;
            color: #ff4757;
            margin-top: 5px;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .auth-btn:active {
            transform: translateY(0);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
            color: #666;
        }

        .auth-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        /* ==================== é¡¶éƒ¨çŠ¶æ€æ  ==================== */
        .status-bar {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1000;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info span {
            font-size: 14px;
            font-weight: 500;
        }

        #userNickname {
            font-weight: bold;
        }

        #userId {
            font-size: 12px;
            opacity: 0.8;
        }

        .connection-status {
            padding: 5px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            font-size: 12px;
        }

        /* ä½ç½®çŠ¶æ€ */
        .location-status {
            padding: 5px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-status:hover {
            background: rgba(255,255,255,0.2);
        }

        /* å³ä¾§é¢æ¿æ§åˆ¶æŒ‰é’® */
        .panel-toggle-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .panel-toggle-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            display: flex;
            height: calc(100vh - 30px);  /* â­ å‡å»é¡¶éƒ¨60pxå’Œåº•éƒ¨60px */
            overflow: hidden;
        }

        /* ==================== å·¦ä¾§ï¼šåœ°å›¾åŒºåŸŸ ==================== */
        .map-container {
            flex: 1;
            position: relative;
            min-width: 0;
            transition: all 0.3s ease;
        }

        .map-container.full-width {
            flex: 1;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #0a1929;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: row;
            gap: 12px;
            z-index: 1000;
            padding: 0; /* ç§»é™¤å†…è¾¹è· */
            background: transparent; /* å®Œå…¨é€æ˜ */
            border-radius: 0; /* ç§»é™¤åœ†è§’ */
            backdrop-filter: none; /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
            box-shadow: none; /* ç§»é™¤é˜´å½± */
            border: none; /* ç§»é™¤è¾¹æ¡† */
            flex-wrap: wrap;
            max-width: calc(100% - 40px);
        }
        .map-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 245, 245, 0.95) 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #052659;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .map-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .map-btn:active {
            transform: translateY(-1px) scale(0.98);
        }


        /* æŒ‰é’®æ–‡å­—æç¤º */
        .map-btn::after {
            content: attr(title);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1001;
        }

        .map-btn:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* ç‰¹å®šæŒ‰é’®æ ·å¼ */
        .map-btn:nth-child(1) { /* ç™»å½•æµ‹è¯•ç”¨æˆ· */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .map-btn:nth-child(2) { /* æ¸…é™¤æ‰€æœ‰æ°”æ³¡ */
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .map-btn:nth-child(3) { /* GPSå®šä½ */
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .map-btn:nth-child(4) { /* æ‰‹åŠ¨é€‰æ‹©ä½ç½® */
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .map-btn.active {
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(255, 255, 255, 0.3);
        }


        /* ä½ç½®æ¨¡å¼æŒ‰é’®ç»„ */
        .location-mode {
            display: flex;
            flex-direction: row;
            gap: 12px;
            width: 100%;
            justify-content: center;
            margin-top: 8px;
        }

        .location-mode-btn {
            flex: 1;
            min-width: 0;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            font-size: 13px;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .location-mode-btn.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .location-mode-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* ==================== å³ä¾§ï¼šæ§åˆ¶é¢æ¿ ==================== */
        .control-panel {
            flex: 0 0 400px;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(84, 131, 179, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .control-panel.collapsed {
            flex: 0 0 0;
            min-width: 0;
            opacity: 0;
            visibility: hidden;
        }

        /* ==================== åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ ==================== */


        .user-item {
            padding: 10px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            margin-bottom: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid #5483B3;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* ==================== æ°”æ³¡åˆ—è¡¨ ==================== */
        .bubbles-list {
            flex: 1;
            padding: 20px;
            border-bottom: 1px solid rgba(84, 131, 179, 0.2);
            overflow-y: auto;
            background: white;
        }

        .bubbles-list h3 {
            color: #052659;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bubble-item {
            padding: 15px;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 4px solid #5483B3;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .bubble-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(84, 131, 179, 0.15);
        }

        .bubble-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .bubble-type {
            font-size: 11px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== å‘å¸ƒæ°”æ³¡è¡¨å• ==================== */
        .publish-form {
            padding: 20px;
            background: white;
            border-top: 1px solid rgba(84, 131, 179, 0.2);
        }

        .publish-form h3 {
            color: #052659;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bubble-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .bubble-type-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #052659;
        }

        .bubble-type-btn.selected {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border-color: #5483B3;
            box-shadow: 0 4px 12px rgba(84, 131, 179, 0.3);
        }

        .publish-form input,
        .publish-form textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .publish-form input:focus,
        .publish-form textarea:focus {
            border-color: #5483B3;
            background: white;
            box-shadow: 0 0 0 3px rgba(84, 131, 179, 0.1);
        }

        .publish-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .publish-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .publish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(84, 131, 179, 0.4);
        }


        /* ==================== åº•éƒ¨å±…ä¸­ï¼šå…¬å±èŠå¤©é¢æ¿ ==================== */
        .chat-panel {
        position: fixed;
        left: 50%;
        bottom: 80px;
        transform: translateX(-50%);
        width: 90%;
        max-width: 600px;
        max-height: 60vh;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        z-index: 2100;
        display: none;
        flex-direction: column;
        overflow: hidden;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(84, 131, 179, 0.2);
    }




        .chat-header {
            padding: 15px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            max-height: 200px;
            padding: 15px;
            overflow-y: auto;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 13px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message .sender {
            font-weight: 600;
            color: #5483B3;
            margin-bottom: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-message .time {
            font-size: 11px;
            color: #6c757d;
            text-align: right;
            margin-top: 4px;
        }

        .chat-message.my-message {
            background: linear-gradient(135deg, #e6f0ff 0%, #c1e8ff 100%);
            border-left: 4px solid #5483B3;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            background: white;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .chat-input-area input:focus {
            border-color: #5483B3;
            background: white;
            box-shadow: 0 0 0 3px rgba(84, 131, 179, 0.1);
        }

        .chat-input-area button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chat-input-area button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(84, 131, 179, 0.3);
        }

        /* ==================== èŠå¤©åˆ‡æ¢æŒ‰é’® ==================== */


     
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* ==================== æ°”æ³¡é¢œè‰²å®šä¹‰ ==================== */
        .bubble-recommend { background: linear-gradient(135deg, #FF4444 0%, #CC0000 100%); }
        .bubble-help { background: linear-gradient(135deg, #FFD700 0%, #FFAA00 100%); color: #333; }
        .bubble-team { background: linear-gradient(135deg, #4169E1 0%, #1E40AF 100%); }
        .bubble-warning { background: linear-gradient(135deg, #9932CC 0%, #6B21A8 100%); }
        .bubble-news { background: linear-gradient(135deg, #FF69B4 0%, #DB2777 100%); }

        /* ==================== ç½‘ç»œçŠ¶æ€æç¤º ==================== */
        .network-status {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-size: 14px;
            display: none;
            backdrop-filter: blur(10px);
            max-width: 80%;
            text-align: center;
        }

        .network-status.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==================== ä½ç½®é€‰æ‹©å¼¹çª— ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            color: #052659;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #052659;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #052659;
        }

        .location-search {
            margin-bottom: 20px;
        }

        .location-search input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        .location-search input:focus {
            border-color: #5483B3;
            background: white;
            box-shadow: 0 0 0 3px rgba(84, 131, 179, 0.1);
            outline: none;
        }

        .location-suggestions {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: white;
        }

        .suggestion-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: #052659;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .suggestion-address {
            font-size: 12px;
            color: #6c757d;
        }

        .confirm-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(84, 131, 179, 0.4);
        }

        /* ==================== ç”¨æˆ·èŒƒå›´åœ†åœˆ ==================== */
        .user-range-circle {
            fillColor: rgba(52, 152, 219, 0.3);
            strokeColor: rgba(52, 152, 219, 0.6);
            strokeWeight: 2;
        }

        /* ==================== ç§èŠæç¤ºæ¡† ==================== */
        .pmHint {
            background: #5483B3;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
        }

        .pmHint:hover {
            background: #4169E1;
        }

        /* ==================== æ»šåŠ¨æ¡ç¾åŒ– ==================== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4169E1 0%, #1E3A8A 100%);
        }

        /* ==================== æ‰‹æœºç«¯é€‚é… ==================== */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: calc(100vh - 60px);  /* â­ å‡å»é¡¶éƒ¨60pxå’Œåº•éƒ¨60px */
            }

            
            .control-panel {
                flex: 0 0 auto;
                max-height: 40vh;
                overflow-y: auto;
                min-width: 100%;
            }
            
            .control-panel.collapsed {
                max-height: 0;
                min-height: 0;
            }
            


            .map-controls {
                top: 10px;
                right: 10px;
                left: 10px;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                padding: 10px;
                border-radius: 30px;
                max-width: calc(100% - 20px);
                gap: 10px;
            }
            
            .map-btn {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
            
            .map-btn::after {
                font-size: 11px;
                padding: 4px 8px;
                bottom: -28px;
            }
            
            .location-mode {
                flex-direction: column;
                gap: 8px;
                margin-top: 10px;
            }
            
            .location-mode-btn {
                padding: 8px 12px;
                font-size: 12px;
                width: 100%;
            }
            
            /* è°ƒæ•´åœ°å›¾å®¹å™¨é«˜åº¦ */
            .map-container {
                height: 60vh;
            }





        
            
            .chat-panel {
                width: 95%;
                max-height: 50vh;
                bottom: 10px;
            }
            
            .chat-messages {
                max-height: 150px;
            }
            

            .status-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }
            
            .panel-toggle-btn {
                position: absolute;
                top: 50%;
                right: 10px;
                transform: translateY(-50%);
            }
            
            .status-bar {
                padding: 10px;
            }
            
            .publish-form {
                padding: 15px;
            }
            
            .bubble-types {
                gap: 5px;
            }
            
            .bubble-type-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .network-status {
                top: 60px;
                padding: 8px 15px;
                font-size: 13px;
            }
            
            .location-status {
                display: none;
            }
        }

        /* å°å±å¹•æ‰‹æœºé€‚é… */
        @media (max-width: 480px) {
            .map-controls {
                gap: 8px;
                padding: 8px;
            }
            
            .map-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .map-btn::after {
                font-size: 10px;
                padding: 3px 6px;
                bottom: -26px;
            }
            
            .location-mode-btn {
                font-size: 11px;
                padding: 6px 10px;
            }
        }


        
        /* ==================== å¹³æ¿ç«¯é€‚é… ==================== */
        @media (min-width: 769px) and (max-width: 1024px) {
            .control-panel {
                flex: 0 0 350px;
            }
            
            .chat-panel {
                width: 80%;
                max-width: 500px;
            }

            .map-controls {
                right: 15px;
                top: 15px;
                padding: 15px;
            }
            
            .map-btn {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }
        }



        /* ==================== ç”¨æˆ·ä½ç½®æ ‡è®°æ ·å¼ ==================== */
        .user-marker-me {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    
        /* ==================== æ°”æ³¡æ ·å¼å¢å¼º ==================== */
        .bubble {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: bubbleAppear 0.5s ease-out, bubbleFloat 3s ease-in-out infinite;
            position: relative;
        }
        
        .bubble:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .bubble.active {
            transform: scale(1.2);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        
        .bubble-recommend {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bubble-help {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .bubble-team {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .bubble-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .bubble-news {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }
        
        .bubble-group {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        @keyframes bubbleAppear {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes bubbleFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }
        
        /* æ°”æ³¡ä¿¡æ¯çª—å£ */
        .bubble-info-window {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 250px;
            max-width: 350px;
        }
        
        .bubble-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .bubble-info-title {
            font-size: 16px;
            font-weight: 600;
            color: #052659;
        }
        
        .bubble-info-type {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .bubble-info-content {
            color: #495057;
            font-size: 14px;
            line-height: 1.6;
            margin: 10px 0;
        }
        
        .bubble-info-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #6c757d;
        }
        
        .bubble-info-author {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .bubble-info-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }
        
        .bubble-info-close:hover {
            background: rgba(0,0,0,0.2);
            color: #000;
        }

    

        /* ==================== åº•éƒ¨åŠŸèƒ½æ  ==================== */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg,rgba(78, 31, 135, 0.95) 0%, rgba(47, 11, 94, 0.98) 100%);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.3);
            z-index: 2000;
        }

        .bottom-btn {
            padding: 6px 20px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bottom-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .bottom-btn.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #052659;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .publish-panel {
        position: fixed;
        right: 20px;
        bottom: 80px;
        width: 350px;
        max-height: 70vh;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        z-index: 2100;
        display: none;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(84, 131, 179, 0.2);
    }

        .publish-panel-header {
        padding: 15px;
        background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
        color: white;
        font-weight: 600;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
        .publish-panel-content {
        padding: 20px;
        overflow-y: auto;
        max-height: 50vh;
    }

     @media (max-width: 768px) {
        .publish-panel {
            width: 90%;
            right: 5%;
            bottom: 70px;
            max-height: 60vh;
        }
        
        .publish-panel-content {
            padding: 15px;
        }
    }


        /* å»ºç¾¤æ°”æ³¡æ ·å¼ */
        .bubble-group {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
        }

        /* æŒ‰é’®åŠ è½½åŠ¨ç”» */
        @keyframes buttonPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .map-btn.loading {
            animation: buttonPulse 1.5s ease-in-out infinite;
        }

        /* æŒ‰é’®ç‚¹å‡»æ³¢çº¹æ•ˆæœ */
        .map-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 1%, transparent 1%);
            transform: translate(-50%, -50%) scale(0);
            border-radius: 50%;
            opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
        }

        .map-btn:active::before {
            transform: translate(-50%, -50%) scale(2);
            opacity: 1;
            transition: 0s;
        }




</style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-container">
            <div class="auth-header">
                <h1>ğŸ—ºï¸ æ­¤åˆ»åœ°å›¾</h1>
                <p>è®°å½•æ­¤åˆ»ï¼Œåˆ†äº«æ­¤åœ°</p>
            </div>

            <!-- ç™»å½•/æ³¨å†Œåˆ‡æ¢æ ‡ç­¾ -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthMode('login')">ç™»å½•</button>
                <button class="auth-tab" onclick="switchAuthMode('register')">æ³¨å†Œ</button>
            </div>

            <!-- çŠ¶æ€æ¶ˆæ¯ -->
            <div class="status-message" id="statusMessage"></div>

            <!-- ç™»å½•è¡¨å• -->
            <div class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label>ID / æ‰‹æœºå·</label>
                    <input type="text" id="loginId" placeholder="è¾“å…¥IDæˆ–æ‰‹æœºå·" autocomplete="username">
                    <div class="form-error" id="loginIdError"></div>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç " autocomplete="current-password">
                    <div class="form-error" id="loginPasswordError"></div>
                </div>
                <button class="auth-btn" onclick="handleLogin()">ç™»å½•</button>
                <div class="auth-footer">
                    è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a class="auth-link" onclick="switchAuthMode('register')">ç«‹å³æ³¨å†Œ</a>
                </div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div class="auth-form" id="registerForm">
                <div class="form-group">
                    <label>æ‰‹æœºå·</label>
                    <input type="tel" id="registerPhone" placeholder="11ä½æ‰‹æœºå·" maxlength="11" autocomplete="tel">
                    <div class="form-hint">ç”¨äºç™»å½•å’Œè´¦å·å®‰å…¨</div>
                    <div class="form-error" id="registerPhoneError"></div>
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·ID</label>
                    <input type="text" id="registerId" placeholder="3-20ä¸ªå­—ç¬¦" maxlength="20" autocomplete="username">
                    <div class="form-hint">ç”¨äºç™»å½•ï¼Œåˆ›å»ºåä¸å¯ä¿®æ”¹</div>
                    <div class="form-error" id="registerIdError"></div>
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="registerUsername" placeholder="æ˜¾ç¤ºåç§°ï¼ˆå¯é€‰ï¼‰" maxlength="20">
                    <div class="form-hint">ä¸å¡«å†™åˆ™é»˜è®¤ä¸ºID</div>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="registerPassword" placeholder="è‡³å°‘6ä½" autocomplete="new-password">
                    <div class="form-error" id="registerPasswordError"></div>
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" id="registerPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç " autocomplete="new-password">
                    <div class="form-error" id="registerPasswordConfirmError"></div>
                </div>
                <button class="auth-btn" onclick="handleRegister()">æ³¨å†Œ</button>
                <div class="auth-footer">
                    å·²æœ‰è´¦å·ï¼Ÿ<a class="auth-link" onclick="switchAuthMode('login')">ç«‹å³ç™»å½•</a>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">

        <div class="status-left">
            <div class="user-info">
                <span id="userNickname">æœªç™»å½•</span>
                <span id="userId">ID: ---</span>
            </div>
            <div class="connection-status">
                <span id="connectionStatus">âŒ æœªè¿æ¥</span>
            </div>
            <div class="location-status" id="locationStatus" onclick="openLocationModal()">
                <span id="locationText">ğŸ“ å®šä½ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å·¦ä¾§ï¼šåœ°å›¾ -->
        <div class="map-container" id="mapContainer">
            <div id="map"></div>
                <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
                <div class="map-controls">
                    <button class="map-btn" onclick="loginTestUser()" title="ç™»å½•æµ‹è¯•ç”¨æˆ·">
                        ğŸ‘¤
                    </button>
                    <button class="map-btn" onclick="clearAllBubbles()" title="æ¸…é™¤æ‰€æœ‰æ°”æ³¡">
                        ğŸ—‘ï¸
                    </button>
                    <button class="map-btn" id="gpsModeBtn" onclick="setLocationMode('gps')" title="GPSå®šä½">
                        ğŸ“
                    </button>
                    <button class="map-btn" id="manualModeBtn" onclick="setLocationMode('manual')" title="æ‰‹åŠ¨é€‰æ‹©ä½ç½®">
                        ğŸ¯
                    </button>
                    
                </div>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="control-panel" id="controlPanel">




            <!-- å‘å¸ƒæ°”æ³¡è¡¨å• -->
            <div class="publish-form">
                <h3>å‘å¸ƒæ–°æ°”æ³¡</h3>
                <div class="bubble-types">
                    <button class="bubble-type-btn" data-type="recommend" onclick="selectBubbleType('recommend')">ğŸ‘ æ¨è</button>
                    <button class="bubble-type-btn" data-type="help" onclick="selectBubbleType('help')">ğŸ†˜ æ±‚åŠ©</button>
                    <button class="bubble-type-btn" data-type="team" onclick="selectBubbleType('team')">ğŸ‘¥ ç»„é˜Ÿ</button>
                    <button class="bubble-type-btn" data-type="group" onclick="selectBubbleType('group')">ğŸ’¬ å»ºç¾¤</button>
                    <button class="bubble-type-btn" data-type="warning" onclick="selectBubbleType('warning')">é¿é›·</button>
                    <button class="bubble-type-btn" data-type="news" onclick="selectBubbleType('news')">è§é—»</button>
                </div>
                <input type="text" id="bubbleTitle" placeholder="æ°”æ³¡æ ‡é¢˜">
                <textarea id="bubbleContent" placeholder="æ°”æ³¡å†…å®¹ï¼ˆå¯é€‰ï¼‰"></textarea>
                <div style="margin-bottom: 12px; font-size: 13px; color: #052659;">
                    å‘å¸ƒä½ç½®: <span id="publishLocationText">ğŸ“ ä½¿ç”¨å½“å‰ä½ç½®</span>
                </div>
                <button class="publish-btn" onclick="publishBubble()">å‘å¸ƒæ°”æ³¡</button>
            </div>
        </div>
    </div>


    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span>ğŸ’¬ èŠå¤©åŒº</span>
            <button onclick="toggleChatPanel()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- åŠ¨æ€ç”ŸæˆèŠå¤©æ¶ˆæ¯ -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="handleChatInputKey(event)" autocomplete="off">
            <button onclick="sendChatMessage()">å‘é€</button>
        </div>
    </div>

    <!-- ä½ç½®é€‰æ‹©å¼¹çª— -->
    <div class="modal" id="locationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“ é€‰æ‹©ä½ç½®</div>
                <button class="modal-close" onclick="closeLocationModal()">Ã—</button>
            </div>
            <div class="location-search">
                <input type="text" id="locationSearchInput" placeholder="æœç´¢åœ°ç‚¹..." oninput="searchLocation()">
                <div class="location-suggestions" id="locationSuggestions">
                    <!-- æœç´¢å»ºè®® -->
                </div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">æˆ–ç›´æ¥åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ç½®</div>
                <div id="selectedLocationInfo" style="padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 13px;">
                    å½“å‰ä½ç½®: ç­‰å¾…é€‰æ‹©...
                </div>
            </div>
            <button class="confirm-btn" onclick="confirmLocation()">ç¡®è®¤é€‰æ‹©</button>
        </div>
    </div>

    <!-- ç½‘ç»œçŠ¶æ€æç¤º -->
    <div class="network-status" id="networkStatus"></div>

    <!-- åœ°å›¾API -->
    <script src="https://map.qq.com/api/js?v=2.exp&key=OB4BZ-D4W3U-JSP5Z-4SFQE-O5CWRQ-CFB47"></script>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        const WS_URL = "ws://121.199.161.5:3000";
        let socket = null;
        let map = null;
        let currentUser = null;
        let myPosition = null;
        let selectedBubbleType = "recommend";
        let bubbles = [];
        let bubbleMarkers = new Map(); // å­˜å‚¨æ°”æ³¡æ ‡è®°
        let currentInfoWindow = null; // å½“å‰æ‰“å¼€çš„ä¿¡æ¯çª—å£
        let chatMessages = [];
        let chatPanelVisible = false;
        let unreadCount = 0;
        let panelCollapsed = true;

        // ä½ç½®ç›¸å…³å˜é‡
        let locationMode = 'gps'; // 'gps' æˆ– 'manual'
        let manualPosition = null;
        let gpsPosition = null;
        let isLocationEnabled = false;
        let gpsWatchId = null;
        
        // ç”¨æˆ·å’Œæ ‡è®°ç®¡ç†
        let myMarker = null;
        let myRangeCircle = null;
        let userMarkers = {}; // å­˜å‚¨å…¶ä»–ç”¨æˆ·çš„æ ‡è®° {userId: marker}
        let userRangeCircles = {}; // å­˜å‚¨å…¶ä»–ç”¨æˆ·çš„èŒƒå›´åœ†åœˆ
        let onlineUsers = {}; // åœ¨çº¿ç”¨æˆ·ä¿¡æ¯ {userId: {lat, lng, nickname, range}}
        let visibleRange = 1000; // å¯è§èŒƒå›´ï¼Œå•ä½ç±³
        
        // å­˜å‚¨å·²å‘é€çš„æ¶ˆæ¯IDï¼Œé¿å…å›å£°é—®é¢˜
        let sentMessageIds = new Set();
        let currentChatroomCode = "000000";

        //æ°”æ³¡æ¸…é™¤
        let clearBubblesFlag = false;
        let clearTimeoutId = null;


        let refreshTimer = null; // å®šæœŸåˆ·æ–°å®šæ—¶å™¨
        // é•¿æŒ‰è®¡æ—¶å™¨
        let longPressTimer = null;
        let longPressDuration = 2000; // 2ç§’
        let currentLongPressMarker = null;

        // ==================== ç™»å½•æ³¨å†Œç›¸å…³å‡½æ•° ====================
        
        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
        function switchAuthMode(mode) {
            const loginTab = document.querySelector('.auth-tab:nth-child(1)');
            const registerTab = document.querySelector('.auth-tab:nth-child(2)');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const statusMessage = document.getElementById('statusMessage');
            
            // æ¸…é™¤çŠ¶æ€æ¶ˆæ¯
            statusMessage.className = 'status-message';
            
            if (mode === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showAuthMessage(message, type = 'error') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.className = 'status-message';
                }, 3000);
            }
        }

        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        function validatePhone(phone) {
            return /^1\d{10}$/.test(phone);
        }

        // å¤„ç†æ³¨å†Œ
        function handleRegister() {
            const phone = document.getElementById('registerPhone').value.trim();
            const id = document.getElementById('registerId').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            // æ¸…é™¤æ‰€æœ‰é”™è¯¯æç¤º
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            // éªŒè¯æ‰‹æœºå·
            if (!phone) {
                showAuthMessage('è¯·è¾“å…¥æ‰‹æœºå·', 'error');
                return;
            }
            if (!validatePhone(phone)) {
                showAuthMessage('æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼Œéœ€è¦11ä½æ•°å­—', 'error');
                return;
            }
            
            // éªŒè¯ID
            if (!id) {
                showAuthMessage('è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }
            if (id.length < 3 || id.length > 20) {
                showAuthMessage('IDé•¿åº¦åº”ä¸º3-20ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            // éªŒè¯å¯†ç 
            if (!password) {
                showAuthMessage('è¯·è¾“å…¥å¯†ç ', 'error');
                return;
            }
            if (password.length < 6) {
                showAuthMessage('å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
                return;
            }
            if (password !== passwordConfirm) {
                showAuthMessage('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error');
                return;
            }
            
            // å‘é€æ³¨å†Œè¯·æ±‚
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'register',
                    phone: phone,
                    id: id,
                    username: username || id,
                    password: password
                }));
                
                showAuthMessage('æ­£åœ¨æ³¨å†Œ...', 'success');
            } else {
                showAuthMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // å¤„ç†ç™»å½•
        function handleLogin() {
            const loginId = document.getElementById('loginId').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // æ¸…é™¤é”™è¯¯æç¤º
            document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
            
            if (!loginId) {
                showAuthMessage('è¯·è¾“å…¥IDæˆ–æ‰‹æœºå·', 'error');
                return;
            }
            if (!password) {
                showAuthMessage('è¯·è¾“å…¥å¯†ç ', 'error');
                return;
            }
            
            // å‘é€ç™»å½•è¯·æ±‚
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'authLogin',
                    loginId: loginId,
                    password: password
                }));
                
                showAuthMessage('æ­£åœ¨ç™»å½•...', 'success');
            } else {
                showAuthMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // éšè—ç™»å½•ç•Œé¢
        function hideAuthOverlay() {
            const authOverlay = document.getElementById('authOverlay');
            authOverlay.style.display = 'none';
        }

        // æ˜¾ç¤ºç™»å½•ç•Œé¢
        function showAuthOverlay() {
            const authOverlay = document.getElementById('authOverlay');
            authOverlay.style.display = 'flex';
        }





        // ==================== è·ç¦»è®¡ç®—å·¥å…·å‡½æ•° ====================
        function calculateDistance(lat1, lng1, lat2, lng2) {
            // å°†ç»çº¬åº¦è½¬æ¢ä¸ºå¼§åº¦
            const toRad = (degree) => degree * Math.PI / 180;
            
            const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // è¿”å›è·ç¦»ï¼ˆç±³ï¼‰
        }


        // ==================== å¯è§æ€§åˆ¤æ–­å‡½æ•° ====================
        function isUserVisible(myPos, myRange, userPos, userRange) {
            if (!myPos || !userPos || !userPos.lat || !userPos.lng) {
                console.log("âš ï¸ ä½ç½®æ•°æ®ä¸å…¨ï¼Œç”¨æˆ·ä¸å¯è§");
                return false;
            }
            
            // è®¡ç®—è·ç¦»
            const distance = calculateDistance(
                myPos.lat, myPos.lng,
                userPos.lat, userPos.lng
            );
            
            // åŒæ–¹äº’ç›¸å¯è§çš„æ¡ä»¶
            const iCanSeeThem = distance <= myRange;
            const theyCanSeeMe = distance <= (userRange || 1000); // å¦‚æœå¯¹æ–¹æ²¡æœ‰èŒƒå›´ï¼Œé»˜è®¤1000ç±³
            
            console.log(`ğŸ“ è·ç¦»: ${Math.round(distance)}ç±³ | æˆ‘çš„èŒƒå›´: ${myRange}ç±³ | å¯¹æ–¹èŒƒå›´: ${userRange || 1000}ç±³`);
            console.log(`ğŸ‘ï¸ æˆ‘èƒ½çœ‹åˆ°å¯¹æ–¹: ${iCanSeeThem} | å¯¹æ–¹èƒ½çœ‹åˆ°æˆ‘: ${theyCanSeeMe}`);
            
            // åŒæ–¹äº’ç›¸å¯è§æ—¶æ‰æ˜¾ç¤º
            return iCanSeeThem && theyCanSeeMe;
        }
        
        // ==================== åˆå§‹åŒ– ====================
        

        window.onload = function() {
            console.log("ğŸš€ æ­¤åˆ»åœ°å›¾ v9.2.1 - ç”¨æˆ·è®¤è¯ç³»ç»Ÿ å·²åŠ è½½");
            
            // å…ˆåˆå§‹åŒ–åœ°å›¾
            initMap();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners();

            document.getElementById('controlPanel').classList.add('collapsed');
            document.getElementById('mapContainer').classList.add('full-width');
            document.querySelector('.bottom-btn:nth-child(1)').classList.remove('active');
            
            // â­ ç«‹å³è¿æ¥WebSocketï¼ˆç”¨äºæ³¨å†Œå’Œç™»å½•ï¼‰
            connectWebSocket();
            
            // â­ æ˜¾ç¤ºç™»å½•ç•Œé¢
            showAuthOverlay();
            
            // å°è¯•è·å–GPSä½ç½®
            getGPSLocation().then(() => {
                console.log("âœ… GPSä½ç½®è·å–å®Œæˆ");
            }).catch((error) => {
                console.error("âŒ GPSä½ç½®è·å–å¤±è´¥:", error);
            });
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯ï¼ˆç™»å½•æˆåŠŸåæ˜¾ç¤ºï¼‰
            function showWelcomeMessage() {
                setTimeout(() => {
                    addChatMessage({
                        from: "ç³»ç»Ÿ",
                        avatar: "ğŸ¤–",
                        text: "æ¬¢è¿ä½¿ç”¨æ­¤åˆ»åœ°å›¾ï¼ä½ å¯ä»¥åœ¨åœ°å›¾ä¸Šå‘å¸ƒæ°”æ³¡ã€æŸ¥çœ‹é™„è¿‘åŠ¨æ€ï¼Œä¹Ÿå¯ä»¥å’Œå…¶ä»–ç”¨æˆ·èŠå¤©ã€‚",
                        time: Date.now(),
                        isSystem: true
                    });
                }, 500);
            }
            
            // åœ¨ç™»å½•æˆåŠŸåè°ƒç”¨æ¬¢è¿æ¶ˆæ¯
            window.showWelcomeMessage = showWelcomeMessage;

            // å®šæœŸè¯·æ±‚åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN && currentUser) {
                    socket.send(JSON.stringify({
                        type: "requestOnlineUsers"
                    }));
                    console.log("ğŸ“¡ è¯·æ±‚åœ¨çº¿ç”¨æˆ·åˆ—è¡¨");
                }
            }, 5000); // æ¯5ç§’è¯·æ±‚ä¸€æ¬¡


            setTimeout(() => {
                startAutoRefresh();
            }, 3000);
        };


// ==================== äº‹ä»¶ç›‘å¬åˆå§‹åŒ– ====================
function initEventListeners() {
    console.log('âœ… åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨');
    
    // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´å¸ƒå±€
    window.addEventListener('resize', handleResize);
    
    // ä½ç½®æœç´¢è¾“å…¥æ¡†äº‹ä»¶
    document.getElementById('locationSearchInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            searchLocation();
        }
    });
    
    // ===== èŠå¤©å®¤ç›¸å…³äº‹ä»¶ç›‘å¬ =====
    console.log('ğŸ” åˆå§‹åŒ–èŠå¤©å®¤ç›¸å…³äº‹ä»¶ç›‘å¬å™¨');
    
    // èŠå¤©å®¤ä»£ç è¾“å…¥æ¡†
    const chatroomInput = document.getElementById('chatroomCodeInput');
    if (chatroomInput) {
        console.log('ğŸ” æ‰¾åˆ°èŠå¤©å®¤ä»£ç è¾“å…¥æ¡†');
        
        chatroomInput.addEventListener('change', function() {
            updateChatroomCode();
        });
        
        chatroomInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                updateChatroomCode();
            }
        });
    }
    
    // èŠå¤©è¾“å…¥æ¡†
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        console.log('ğŸ” æ‰¾åˆ°èŠå¤©è¾“å…¥æ¡†');
        
        chatInput.addEventListener('focus', function() {
            updateChatInputPlaceholder();
        });
    }
    
    // åˆå§‹åŒ–èŠå¤©è¾“å…¥æ¡†æç¤º
    updateChatInputPlaceholder();
}

        // ==================== å“åº”å¼å¸ƒå±€å¤„ç† ====================
        function handleResize() {
            if (window.innerWidth <= 768) {
                // æ‰‹æœºç«¯ï¼šè‡ªåŠ¨è°ƒæ•´å¸ƒå±€
                document.body.classList.add('mobile');
            } else {
                document.body.classList.remove('mobile');
            }
        }

        // ==================== é¢æ¿æ”¶èµ·/å±•å¼€åŠŸèƒ½ ====================
        function togglePanel() {
            const panel = document.getElementById('controlPanel');
            const mapContainer = document.getElementById('mapContainer');

            panelCollapsed = !panelCollapsed;
            
            if (panelCollapsed) {
                panel.classList.add('collapsed');
                mapContainer.classList.add('full-width');
                toggleBtn.textContent = 'å±•å¼€é¢æ¿';
            } else {
                panel.classList.remove('collapsed');
                mapContainer.classList.remove('full-width');
                toggleBtn.textContent = 'æ”¶èµ·é¢æ¿';
            }
        }

        // ==================== åœ°å›¾åˆå§‹åŒ– ====================
        function initMap() {
            // é»˜è®¤ä½ç½®ï¼ˆä¸Šæµ·ä¸­å¿ƒï¼‰
            const defaultPosition = { lat: 31.2800, lng: 121.5000 };
            
            // åˆ›å»ºåœ°å›¾å®ä¾‹
            map = new qq.maps.Map(document.getElementById('map'), {
                center: new qq.maps.LatLng(defaultPosition.lat, defaultPosition.lng),
                zoom: 15,
                backgroundColor: '#0a1929',
                mapStyle: {
                    styleId: 'dark'
                },
                // æ·»åŠ ä»¥ä¸‹é…ç½®ç¦ç”¨æ§ä»¶
                disableDefaultUI: true, // ç¦ç”¨æ‰€æœ‰é»˜è®¤æ§ä»¶
                // æˆ–è€…åªç¦ç”¨ç‰¹å®šçš„æ§ä»¶ï¼š
                // mapTypeControl: false, // ç¦ç”¨åœ°å›¾ç±»å‹åˆ‡æ¢æ§ä»¶ï¼ˆåŒ…æ‹¬å«æ˜Ÿå›¾ï¼‰
                // scaleControl: false,   // ç¦ç”¨æ¯”ä¾‹å°º
                // zoomControl: false,    // ç¦ç”¨ç¼©æ”¾æ§ä»¶
                // panControl: false      // ç¦ç”¨å¹³ç§»æ§ä»¶
            });
            
            // å¦‚æœæ‚¨éœ€è¦ä¿ç•™ç¼©æ”¾æ§ä»¶ï¼Œå¯ä»¥é‡æ–°å¯ç”¨å®ƒ
            // map.setOptions({
            //     zoomControl: true,
            //     zoomControlOptions: {
            //         position: qq.maps.ControlPosition.RIGHT_CENTER
            //     }
            // });
            
            // åœ°å›¾åˆå§‹åŒ–å®Œæˆåè¯·æ±‚é™„è¿‘æ°”æ³¡
            console.log("ğŸ“ åœ°å›¾å·²åˆå§‹åŒ–ï¼Œå‡†å¤‡è¯·æ±‚é™„è¿‘æ°”æ³¡");
            setTimeout(() => {
                requestNearbyBubbles();
            }, 1000);

            console.log("âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆ");
            
            // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºæ‰‹åŠ¨é€‰æ‹©ä½ç½®ï¼‰
            qq.maps.event.addListener(map, 'click', function(event) {
                if (locationMode === 'manual') {
                    handleMapClick(event);
                }
            });
        }
        // ==================== GPSå®šä½åŠŸèƒ½ï¼ˆå€Ÿé‰´æä¾›çš„ä»£ç ï¼‰====================
        function getGPSLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    console.log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒGeolocationï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                    myPosition = { lat: 39.9042, lng: 116.4074 };
                    showNetworkStatus('æµè§ˆå™¨ä¸æ”¯æŒå®šä½ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰', 3000);
                    resolve(myPosition);
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        gpsPosition = { lat: lat, lng: lng };
                        
                        // å¦‚æœå½“å‰æ˜¯GPSæ¨¡å¼ï¼Œæ›´æ–°ä½ç½®
                        if (locationMode === 'gps') {
                            updateMyPosition(gpsPosition);
                        }
                        
                        console.log('âœ… è·å–åˆ°GPSå®šä½:', gpsPosition);
                        showNetworkStatus(`å®šä½æˆåŠŸ (ç²¾åº¦: ${Math.round(position.coords.accuracy)}ç±³)`, 2000);
                        resolve(gpsPosition);
                        
                        // å¼€å§‹æŒç»­ç›‘æ§GPSä½ç½®
                        startGPSWatching();
                    },
                    (error) => {
                        console.log('âš ï¸ å®šä½å¤±è´¥:', error.message);
                        
                        let errorMessage = 'å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆåŒ—äº¬å¤©å®‰é—¨ï¼‰';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½ç½®æƒé™ï¼Œç„¶ååˆ·æ–°é¡µé¢';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'å®šä½è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®';
                                break;
                        }
                        
                        showNetworkStatus(errorMessage, 4000);
                        myPosition = { lat: 39.9042, lng: 116.4074 };
                        resolve(myPosition);
                    },
                    options
                );
            });
        }

        function startGPSWatching() {
            if (!navigator.geolocation || gpsWatchId) return;
            
            gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    gpsPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // å¦‚æœå½“å‰æ˜¯GPSæ¨¡å¼ï¼Œæ›´æ–°ä½ç½®
                    if (locationMode === 'gps') {
                        updateMyPosition(gpsPosition);
                    }
                    
                    updateLocationStatus("ğŸ“ å®æ—¶å®šä½ä¸­");
                },
                (error) => {
                    console.error("GPSç›‘æ§é”™è¯¯:", error);
                    updateLocationStatus("âŒ å®šä½å¤±è´¥");
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 30000
                }
            );
            
            isLocationEnabled = true;
        }

        function stopGPSWatching() {
            if (gpsWatchId && navigator.geolocation) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            isLocationEnabled = false;
        }

        // ==================== ä½ç½®æ¨¡å¼è®¾ç½® ====================
        function setLocationMode(mode) {
            locationMode = mode;
            
            // è·å–æ‰€æœ‰ç›¸å…³æŒ‰é’®
            const gpsCircleBtn = document.getElementById('gpsModeBtn');
            const manualCircleBtn = document.getElementById('manualModeBtn');
            const gpsTextBtn = document.getElementById('gpsModeTextBtn');
            const manualTextBtn = document.getElementById('manualModeTextBtn');
            
            // åˆ›å»ºæŒ‰é’®æ•°ç»„ï¼Œè¿‡æ»¤æ‰ä¸å­˜åœ¨çš„
            const buttons = [gpsCircleBtn, manualCircleBtn];
            if (gpsTextBtn) buttons.push(gpsTextBtn);
            if (manualTextBtn) buttons.push(manualTextBtn);
            
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€ï¼ˆåªå¯¹å­˜åœ¨çš„æŒ‰é’®æ“ä½œï¼‰
            buttons.forEach(btn => {
                if (btn) btn.classList.remove('active');
            });
            
            if (mode === 'gps') {
                // æ¿€æ´»GPSæ¨¡å¼æŒ‰é’®
                if (gpsCircleBtn) gpsCircleBtn.classList.add('active');
                if (gpsTextBtn) gpsTextBtn.classList.add('active');
                
                // å¯ç”¨GPSå®šä½
                if (gpsPosition) {
                    updateMyPosition(gpsPosition);
                } else {
                    getGPSLocation();
                }
                
                showNetworkStatus("å·²åˆ‡æ¢åˆ°GPSå®šä½æ¨¡å¼", 2000);
            } else {
                // æ¿€æ´»æ‰‹åŠ¨æ¨¡å¼æŒ‰é’®
                if (manualCircleBtn) manualCircleBtn.classList.add('active');
                if (manualTextBtn) manualTextBtn.classList.add('active');
                
                // åœæ­¢GPSç›‘æ§
                stopGPSWatching();
                
                // æç¤ºç”¨æˆ·ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®
                showNetworkStatus("è¯·ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®", 2000);
            }
            
            updateLocationDisplay();
        }

        // ==================== æ‰‹åŠ¨ä½ç½®é€‰æ‹© ====================
        function handleMapClick(event) {
            if (locationMode === 'manual') {
                manualPosition = {
                    lat: event.latLng.getLat(),
                    lng: event.latLng.getLng()
                };
                
                updateMyPosition(manualPosition);
                showNetworkStatus(`å·²é€‰æ‹©ä½ç½®: ${manualPosition.lat.toFixed(4)}, ${manualPosition.lng.toFixed(4)}`, 2000);
                
                // æ›´æ–°ä½ç½®é€‰æ‹©å¼¹çª—ä¸­çš„ä¿¡æ¯
                if (document.getElementById('locationModal').style.display === 'flex') {
                    updateLocationModalInfo();
                }
            }
        }

        // ==================== æ›´æ–°æˆ‘çš„ä½ç½®ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰====================
        function updateMyPosition(position) {
            myPosition = position;
            
            console.log("ğŸ“ æ›´æ–°æˆ‘çš„ä½ç½®:", position);
            
            // æ›´æ–°æˆ‘çš„ä½ç½®æ ‡è®°
            updateMyMarker();
            
            // æ›´æ–°æˆ‘çš„èŒƒå›´åœ†åœˆ
            updateMyRange();
            
            // æ›´æ–°åœ°å›¾ä¸­å¿ƒï¼ˆå¹³æ»‘ç§»åŠ¨ï¼‰
            if (map) {
                map.panTo(new qq.maps.LatLng(position.lat, position.lng));
            }
            
            // æ›´æ–°å‘å¸ƒä½ç½®æ˜¾ç¤º
            updatePublishLocationDisplay();
            
            // åˆ·æ–°æ‰€æœ‰ç”¨æˆ·æ ‡è®°ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
            refreshAllMarkers();
            
            // å‘é€ä½ç½®åˆ°æœåŠ¡å™¨
            sendPositionToServer();
        }

        // ==================== æ›´æ–°æˆ‘çš„æ ‡è®° ====================
        function updateMyMarker() {
            if (!map || !myPosition) return;
            
            // ç§»é™¤æ—§çš„æ ‡è®°
            if (myMarker) {
                myMarker.setMap(null);
            }
            
            // åˆ›å»ºæ–°çš„æ ‡è®°
            const icon = new qq.maps.MarkerImage(
                'data:image/svg+xml;utf8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                        <!-- å¤–åœˆå‘å…‰æ•ˆæœ -->
                        <circle cx="24" cy="24" r="22" fill="#FFAA00" 
                                stroke="white" stroke-width="2"
                                filter="url(#shadow)"/>
                        
                        <!-- å†…åœˆ -->
                        <circle cx="24" cy="24" r="16" fill="white" opacity="0.9"/>
                        
                        <!-- ç”¨æˆ·å›¾æ ‡ -->
                        <text x="24" y="32" text-anchor="middle" 
                            fill="#FFAA00" font-size="20" 
                            font-family="Arial, sans-serif" font-weight="bold">
                            ğŸ‘¤
                        </text>
                        
                        <!-- å°åœ†ç‚¹ï¼ˆåœ¨çº¿æŒ‡ç¤ºå™¨ï¼‰ -->
                        <circle cx="36" cy="12" r="4" fill="#00FF88" 
                                stroke="white" stroke-width="1.5"/>
                        
                        <defs>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                                <feOffset dx="0" dy="0" result="offsetblur"/>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                    </svg>
                `),
                new qq.maps.Size(48, 48),
                new qq.maps.Point(0, 0),
                new qq.maps.Point(24, 24)
            );


            myMarker = new qq.maps.Marker({
                map: map,
                position: new qq.maps.LatLng(myPosition.lat, myPosition.lng),
                title: currentUser ? currentUser.nickname : 'æˆ‘çš„ä½ç½®',
                icon: icon
            });
            

        }

        // ==================== æ›´æ–°æˆ‘çš„å¯è§èŒƒå›´åœ†åœˆ ====================
        function updateMyRange() {
            if (!map || !myPosition) return;
            
            // ç§»é™¤æ—§çš„åœ†åœˆ
            if (myRangeCircle) {
                myRangeCircle.setMap(null);
            }
            
            // åˆ›å»ºæ–°çš„å¯è§èŒƒå›´åœ†åœˆ
            myRangeCircle = new qq.maps.Circle({
                map: map,
                center: new qq.maps.LatLng(myPosition.lat, myPosition.lng),
                radius: visibleRange,
                fillColor: new qq.maps.Color(52, 152, 219, 0.3),
                strokeColor: new qq.maps.Color(52, 152, 219, 0.6),
                strokeWeight: 2
            });
        }


        // ==================== åˆ·æ–°æ‰€æœ‰ç”¨æˆ·æ ‡è®°ï¼ˆæ–°ç‰ˆï¼‰====================
        function refreshAllMarkers() {
            console.log("ğŸ”„ å¼€å§‹åˆ·æ–°æ‰€æœ‰ç”¨æˆ·æ ‡è®°");
            
            if (!myPosition || !map) {
                console.log("âš ï¸ æ— æ³•åˆ·æ–°ï¼šåœ°å›¾æˆ–æˆ‘çš„ä½ç½®ä¸å­˜åœ¨");
                return;
            }
            
            const myLatLng = new qq.maps.LatLng(myPosition.lat, myPosition.lng);
            
            // 1. æ›´æ–°æˆ‘çš„æ ‡è®°ä½ç½®
            if (myMarker) {
                myMarker.setPosition(myLatLng);
                console.log("ğŸ“ æ›´æ–°æˆ‘çš„æ ‡è®°ä½ç½®");
            }
            
            // 2. æ›´æ–°æˆ‘çš„èŒƒå›´åœ†åœˆä½ç½®
            if (myRangeCircle) {
                myRangeCircle.setCenter(myLatLng);
                console.log("ğŸ”µ æ›´æ–°æˆ‘çš„èŒƒå›´åœ†åœˆä½ç½®");
            }
            
            // 3. è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            const onlineUserIds = Object.keys(onlineUsers);
            console.log(`ğŸ‘¥ åœ¨çº¿ç”¨æˆ·æ•°é‡: ${onlineUserIds.length}`);
            
            // 4. å¤„ç†æ¯ä¸ªåœ¨çº¿ç”¨æˆ·
            onlineUserIds.forEach(userId => {
                const user = onlineUsers[userId];
                
                // è·³è¿‡è‡ªå·±
                if (currentUser && userId === currentUser.id) {
                    console.log(`â­ï¸ è·³è¿‡è‡ªå·±: ${userId}`);
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ä½ç½®
                if (!user || !user.lat || !user.lng) {
                    console.log(`âš ï¸ ç”¨æˆ· ${userId} æ— ä½ç½®ä¿¡æ¯`);
                    if (userMarkers[userId]) {
                        userMarkers[userId].setMap(null);
                    }
                    if (userRangeCircles[userId]) {
                        userRangeCircles[userId].setMap(null);
                    }
                    return;
                }
                
                // ä½¿ç”¨æˆ‘ä»¬æ–°å†™çš„å‡½æ•°åˆ¤æ–­æ˜¯å¦å¯è§
                const isVisible = isUserVisible(
                    myPosition, 
                    visibleRange, 
                    { lat: user.lat, lng: user.lng }, 
                    user.range || 1000
                );
                
                console.log(`ğŸ‘¤ ${user.nickname} (${userId}): ${isVisible ? 'âœ… å¯è§' : 'âŒ ä¸å¯è§'}`);
                
                // å¦‚æœä¸å¯è§ï¼Œéšè—æ ‡è®°å’ŒèŒƒå›´åœ†åœˆ
                if (!isVisible) {
                    if (userMarkers[userId]) {
                        userMarkers[userId].setMap(null);
                        console.log(`   ğŸ—‘ï¸ éšè—ç”¨æˆ·æ ‡è®°: ${user.nickname}`);
                    }
                    if (userRangeCircles[userId]) {
                        userRangeCircles[userId].setMap(null);
                        console.log(`   ğŸ—‘ï¸ éšè—ç”¨æˆ·èŒƒå›´åœ†åœˆ: ${user.nickname}`);
                    }
                    return;
                }
                
                // å¦‚æœå¯è§ï¼Œæ˜¾ç¤ºæ ‡è®°å’ŒèŒƒå›´åœ†åœˆ
                const theirLatLng = new qq.maps.LatLng(user.lat, user.lng);
                
                // åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·æ ‡è®°
                if (!userMarkers[userId]) {
                    console.log(`   ğŸ†• åˆ›å»ºæ–°ç”¨æˆ·æ ‡è®°: ${user.nickname}`);
                    
                    const icon = new qq.maps.MarkerImage(
                        'data:image/svg+xml;utf8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                                <circle cx="20" cy="20" r="18" fill="#FFAA00" stroke="white" stroke-width="2"/>
                                <text x="20" y="28" text-anchor="middle" fill="white" font-size="18" font-family="Arial">ğŸ‘¤</text>
                            </svg>
                        `),
                        new qq.maps.Size(40, 40),
                        new qq.maps.Point(0, 0),
                        new qq.maps.Point(20, 20)
                    );
                    
                    const marker = new qq.maps.Marker({
                        map: map,
                        position: theirLatLng,
                        title: `${user.nickname} (${userId})`,
                        icon: icon
                    });
                    
                    // æ·»åŠ æ ‡ç­¾
                    // ç§»é™¤æ ‡ç­¾ï¼ˆä¸è¦ç™½è‰²æ¡†æ¡†ï¼‰
                    // const label = new qq.maps.Label({
                    //     map: map,
                    //     position: theirLatLng,
                    //     content: user.nickname,
                    //     offset: new qq.maps.Size(0, -25)
                    // });

                    // marker.label = label;
                    userMarkers[userId] = marker;



                    let pressTimer = null;
                    let currentPressedMarker = null;
                    let isPressing = false;

                    // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                    qq.maps.event.addListener(marker, 'mousedown', function() {
                        pressTimer = setTimeout(function() {
                            showUserInfoWindow(user, theirLatLng);
                            isPressing = true;
                            currentPressedMarker = marker;
                        }, 2000); // é•¿æŒ‰2ç§’
                    });

                    // è§¦æ‘¸å¼€å§‹äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    qq.maps.event.addListener(marker, 'touchstart', function(e) {
                        // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨
                        if (e && e.domEvent) {
                            e.domEvent.preventDefault();
                        }
                        
                        pressTimer = setTimeout(function() {
                            showUserInfoWindow(user, theirLatLng);
                            isPressing = true;
                            currentPressedMarker = marker;
                        }, 2000); // é•¿æŒ‰2ç§’
                    });

                    // é¼ æ ‡æ¾å¼€äº‹ä»¶
                    qq.maps.event.addListener(marker, 'mouseup', function() {
                        clearTimeout(pressTimer);
                    });

                    // é¼ æ ‡ç¦»å¼€äº‹ä»¶
                    qq.maps.event.addListener(marker, 'mouseout', function() {
                        clearTimeout(pressTimer);
                    });

                    // è§¦æ‘¸ç»“æŸäº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    qq.maps.event.addListener(marker, 'touchend', function(e) {
                        // é˜»æ­¢é»˜è®¤è¡Œä¸º
                        if (e && e.domEvent) {
                            e.domEvent.preventDefault();
                        }
                        clearTimeout(pressTimer);
                    });

                    // è§¦æ‘¸å–æ¶ˆäº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    qq.maps.event.addListener(marker, 'touchcancel', function() {
                        clearTimeout(pressTimer);
                    });

                    // ç‚¹å‡»æ ‡è®°äº‹ä»¶ï¼ˆç‚¹å‡»æ—¶å…³é—­ä¿¡æ¯çª—å£ï¼‰
                    qq.maps.event.addListener(marker, 'click', function() {
                        hideUserInfoWindow();
                    });

                    // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬ï¼Œé˜²æ­¢é•¿æŒ‰æ—¶åœ°å›¾ç§»åŠ¨
                    function addGlobalEventListeners() {
                        // é˜»æ­¢åœ°å›¾åœ¨é•¿æŒ‰æ—¶ç§»åŠ¨
                        qq.maps.event.addListener(map, 'mousedown', function() {
                            isPressing = true;
                        });
                        
                        qq.maps.event.addListener(map, 'mouseup', function() {
                            isPressing = false;
                        });
                        
                        qq.maps.event.addListener(map, 'touchstart', function(e) {
                            isPressing = true;
                        });
                        
                        qq.maps.event.addListener(map, 'touchend', function(e) {
                            isPressing = false;
                        });
                    }

                    // åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨
                    setTimeout(addGlobalEventListeners, 1000);              



                    
                } else {
                    // æ›´æ–°ç°æœ‰æ ‡è®°ä½ç½®
                    userMarkers[userId].setPosition(theirLatLng);
                    if (userMarkers[userId].label) {
                        userMarkers[userId].label.setPosition(theirLatLng);
                    }
                    userMarkers[userId].setMap(map);
                    console.log(`   ğŸ”„ æ›´æ–°ç”¨æˆ·æ ‡è®°ä½ç½®: ${user.nickname}`);
                }
                
                // åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·èŒƒå›´åœ†åœˆ
                if (!userRangeCircles[userId]) {
                    console.log(`   ğŸ†• åˆ›å»ºç”¨æˆ·èŒƒå›´åœ†åœˆ: ${user.nickname} (${user.range || 1000}ç±³)`);
                    
                    userRangeCircles[userId] = new qq.maps.Circle({
                        map: map,
                        center: theirLatLng,
                        radius: user.range || 1000,
                        fillColor: new qq.maps.Color(255, 170, 0, 0.2),
                        strokeColor: new qq.maps.Color(255, 170, 0, 0.5),
                        strokeWeight: 1
                    });
                } else {
                    userRangeCircles[userId].setCenter(theirLatLng);
                    userRangeCircles[userId].setRadius(user.range || 1000);
                    userRangeCircles[userId].setMap(map);
                    console.log(`   ğŸ”„ æ›´æ–°ç”¨æˆ·èŒƒå›´åœ†åœˆ: ${user.nickname}`);
                }
            });
            
            console.log("âœ… åˆ·æ–°æ‰€æœ‰ç”¨æˆ·æ ‡è®°å®Œæˆ");
        }


        // ==================== ç”¨æˆ·æ ‡è®°æ‚¬åœåŠŸèƒ½ ====================
        let currentUserInfoWindow = null;

        function showUserInfoWindow(user, position) {
            // ç§»é™¤ç°æœ‰çš„ä¿¡æ¯çª—å£
            if (currentUserInfoWindow) {
                currentUserInfoWindow.close();
            }

            showNetworkStatus(`ğŸ‘† é•¿æŒ‰æˆåŠŸ - ä¿¡æ¯çª—å£å°†åœ¨10ç§’åè‡ªåŠ¨å…³é—­ï¼Œæˆ–ç‚¹å‡»åœ°å›¾å…³é—­`, 2000);
            
            // åˆ›å»ºè¯ä¸¸å½¢æ€çš„ä¿¡æ¯çª—å£å†…å®¹ï¼ˆæ— èƒŒæ™¯æ¡†ï¼‰
            const content = `
                <div style="
                    background: transparent;
                    padding: 8px 12px 8px 8px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    pointer-events: auto;
                ">
                    <!-- å·¦ä¾§ï¼šç”¨æˆ·å¤´åƒåœ† -->
                    <div style="
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 16px;
                        flex-shrink: 0;
                        border: 2px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">
                        ${user.avatar || 'ğŸ‘¤'}
                    </div>
                    
                    <!-- ä¸­é—´ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆè¯ä¸¸èƒŒæ™¯ï¼‰ -->
                    <div style="
                        flex: 1;
                        min-width: 0;
                        overflow: hidden;
                        background: linear-gradient(135deg, rgba(248, 249, 250, 0.95) 0%, rgba(233, 236, 239, 0.95) 100%);
                        backdrop-filter: blur(10px);
                        border-radius: 50px;
                        padding: 6px 15px 6px 12px;
                        border: 2px solid rgba(84, 131, 179, 0.8);
                        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
                    ">
                        <div style="
                            font-weight: 600;
                            color: #052659;
                            font-size: 11px;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            margin-bottom: 1px;
                        ">
                            ${user.nickname}
                        </div>
                        <div style="
                            font-size: 9px;
                            color: #6c757d;
                            font-family: 'Courier New', monospace;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        ">
                            ${user.userId ? 'ID: ' + user.userId.substring(0, 8) + '...' : 'ID: æœªçŸ¥'}
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šç§èŠæŒ‰é’®åœ† -->
                    <button onclick="openPrivateChat('${user.userId}', '${user.nickname}')" 
                            style="
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF4757 100%);
                                color: white;
                                border: 2px solid white;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: bold;
                                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                flex-shrink: 0;
                                box-shadow: 0 3px 12px rgba(255, 107, 107, 0.5);
                                position: relative;
                                overflow: hidden;
                                z-index: 10;
                            "
                            onmouseover="
                                this.style.transform='translateY(-2px) scale(1.1)';
                                this.style.boxShadow='0 5px 18px rgba(255, 107, 107, 0.8)';
                            "
                            onmouseout="
                                this.style.transform='translateY(0) scale(1)';
                                this.style.boxShadow='0 3px 12px rgba(255, 107, 107, 0.5)';
                            "
                            title="ç§èŠ ${user.nickname}"
                    >
                        ğŸ’¬
                        <!-- è„‰å†²åŠ¨ç”»æ•ˆæœ -->
                        <span style="
                            position: absolute;
                            width: 100%;
                            height: 100%;
                            border-radius: 50%;
                            background: rgba(255, 255, 255, 0.3);
                            animation: pulse 2s infinite;
                            pointer-events: none;
                        "></span>
                    </button>
                </div>
            `;
            
            // åˆ›å»ºä¿¡æ¯çª—å£ï¼ˆä¸‹ç§»æ›´å¤šï¼‰
            currentUserInfoWindow = new qq.maps.InfoWindow({
                map: map,
                position: position,
                content: content,
                offset: new qq.maps.Size(0, -80) // ä¸‹ç§»æ›´å¤šï¼Œåœ¨æ ‡è®°ä¸‹æ–¹æ˜¾ç¤º
            });
            
            currentUserInfoWindow.open();
            
            console.log(`ğŸ‘¤ æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯: ${user.nickname}`);
            
            // 10ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                hideUserInfoWindow();
            }, 10000);


            currentUserInfoWindow.open();
    
            console.log(`ğŸ‘¤ æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯: ${user.nickname}`);
            
            // 10ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                hideUserInfoWindow();
            }, 10000); // 10ç§’åè‡ªåŠ¨å…³é—­
            
            // æ·»åŠ ç‚¹å‡»åœ°å›¾å…³é—­åŠŸèƒ½
            qq.maps.event.addListenerOnce(map, 'click', function() {
                hideUserInfoWindow();
            });
            
            // æ·»åŠ åœ°å›¾æ‹–åŠ¨å…³é—­åŠŸèƒ½
            qq.maps.event.addListenerOnce(map, 'dragstart', function() {
                hideUserInfoWindow();
            });

        }

        function hideUserInfoWindow() {
            if (currentUserInfoWindow) {
                currentUserInfoWindow.close();
                currentUserInfoWindow = null;
            }
        }


        // ==================== å®šæœŸåˆ·æ–°å‡½æ•° ====================
        function startAutoRefresh() {
            console.log("ğŸ”„ å¯åŠ¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ï¼ˆæ¯5ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰");
            
            // å¦‚æœå·²æœ‰å®šæ—¶å™¨ï¼Œå…ˆæ¸…é™¤
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            // åˆ›å»ºæ–°çš„å®šæ—¶å™¨ï¼Œæ¯5ç§’åˆ·æ–°ä¸€æ¬¡
            refreshTimer = setInterval(() => {
                console.log("â° å®šæ—¶åˆ·æ–°è§¦å‘");
                
                // å¦‚æœæ¸…é™¤æ¨¡å¼ä¸­ï¼Œä¸è¯·æ±‚æ°”æ³¡
                if (clearBubblesFlag) {
                    console.log("â¸ï¸ æ¸…é™¤æ¨¡å¼ä¸­ï¼Œè·³è¿‡æ°”æ³¡è¯·æ±‚");
                    return;
                }


                // å¦‚æœå·²ç™»å½•ä¸”æœ‰åœ°å›¾ï¼Œå°±åˆ·æ–°æ ‡è®°
                if (currentUser && map) {
                    // 1. å…ˆè¯·æ±‚åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: "requestOnlineUsers"
                        }));
                        console.log("ğŸ“¡ å®šæ—¶è¯·æ±‚åœ¨çº¿ç”¨æˆ·åˆ—è¡¨");
                    }
                    
                    // 2. åˆ·æ–°æ ‡è®°ï¼ˆå³ä½¿ä½ç½®ä¸å˜ä¹Ÿåˆ·æ–°ï¼‰
                    refreshAllMarkers();
                    
                    // 3. è¯·æ±‚é™„è¿‘æ°”æ³¡
                    requestNearbyBubbles();
                } else {
                    console.log("â¸ï¸ å®šæ—¶åˆ·æ–°æš‚åœï¼šç”¨æˆ·æœªç™»å½•æˆ–åœ°å›¾æœªåˆå§‹åŒ–");
                }
            }, 5000); // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
            
            console.log("âœ… è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨å·²å¯åŠ¨");
        }

        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
                console.log("ğŸ›‘ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨å·²åœæ­¢");
            }
        }


        // ==================== æ˜¾ç¤ºç§èŠæç¤ºï¼ˆå€Ÿé‰´æä¾›çš„ä»£ç ï¼‰====================
        function showPrivateChatHint(userId, nickname, position) {
            // ç®€åŒ–ä¸ºç›´æ¥ä½¿ç”¨æ–°çš„æ‚¬åœåŠŸèƒ½
            // è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± showUserInfoWindow æ›¿ä»£
            console.log(`ğŸ“¢ æç¤º: ç‚¹å‡»ç”¨æˆ·æ ‡è®°å¯æŸ¥çœ‹ ${nickname} çš„è¯¦ç»†ä¿¡æ¯`);
        }


        function openPrivateChat(userId, nickname) {
            // å…³é—­ä¿¡æ¯çª—å£
            hideUserInfoWindow();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNetworkStatus(`ğŸ’¬ å‡†å¤‡ä¸ ${nickname} ç§èŠ...`, 2000);
            
            // æš‚æ—¶å…ˆæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
            addChatMessage({
                from: "ç³»ç»Ÿ",
                avatar: "ğŸ¤–",
                text: `å·²ä¸ºæ‚¨è¿æ¥åˆ° ${nickname} çš„ç§èŠï¼Œè¯·è¾“å…¥æ¶ˆæ¯...`,
                time: Date.now(),
                isSystem: true
            });
            
            // æ‰“å¼€èŠå¤©é¢æ¿
            if (!chatPanelVisible) {
                toggleChatPanel();
            }
            
            // åœ¨è¾“å…¥æ¡†ä¸­æ·»åŠ ç§èŠæ ‡è®°
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `[ç§èŠ ${nickname}] `;
            chatInput.focus();
            
            console.log(`ğŸ’¬ æ‰“å¼€ç§èŠ: ${nickname} (${userId})`);
        }

        // ==================== ä½ç½®å¼¹çª—åŠŸèƒ½ ====================
        function openLocationModal() {
            document.getElementById('locationModal').style.display = 'flex';
            document.getElementById('locationSearchInput').focus();
        }

        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
            document.getElementById('locationSearchInput').value = '';
            document.getElementById('locationSuggestions').innerHTML = '';
        }

        function searchLocation() {
            const input = document.getElementById('locationSearchInput').value.trim();
            const suggestionsDiv = document.getElementById('locationSuggestions');
            
            if (!input) {
                suggestionsDiv.innerHTML = '<div class="suggestion-item"><div class="suggestion-name">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div></div>';
                return;
            }
            
            // ä½¿ç”¨è…¾è®¯åœ°å›¾æœç´¢API
            const search = new qq.maps.Search({
                complete: function(results) {
                    suggestionsDiv.innerHTML = '';
                    
                    if (results.detail && results.detail.pois && results.detail.pois.length > 0) {
                        results.detail.pois.slice(0, 5).forEach(poi => {
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.innerHTML = `
                                <div class="suggestion-name">${poi.name}</div>
                                <div class="suggestion-address">${poi.address || 'æ— åœ°å€ä¿¡æ¯'}</div>
                            `;
                            item.onclick = () => selectLocationFromSearch(poi);
                            suggestionsDiv.appendChild(item);
                        });
                    } else {
                        suggestionsDiv.innerHTML = '<div class="suggestion-item"><div class="suggestion-name">æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹</div></div>';
                    }
                }
            });
            
            search.search(input);
        }

        function selectLocationFromSearch(poi) {
            manualPosition = {
                lat: poi.latLng.lat,
                lng: poi.latLng.lng
            };
            
            // åˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼
            setLocationMode('manual');
            
            // æ›´æ–°ä½ç½®
            updateMyPosition(manualPosition);
            
            // æ›´æ–°å¼¹çª—ä¿¡æ¯
            updateLocationModalInfo();
            
            // å°†åœ°å›¾ä¸­å¿ƒç§»åŠ¨åˆ°é€‰æ‹©çš„ä½ç½®
            if (map) {
                map.panTo(new qq.maps.LatLng(manualPosition.lat, manualPosition.lng));
            }
            
            document.getElementById('locationSearchInput').value = poi.name;
            document.getElementById('locationSuggestions').innerHTML = '';
            
            showNetworkStatus(`å·²é€‰æ‹©: ${poi.name}`, 2000);
        }

        function updateLocationModalInfo() {
            const infoDiv = document.getElementById('selectedLocationInfo');
            const modeText = locationMode === 'gps' ? 'GPSå®šä½' : 'æ‰‹åŠ¨é€‰æ‹©';
            const posText = manualPosition || myPosition;
            
            infoDiv.innerHTML = `
                <div><strong>æ¨¡å¼:</strong> ${modeText}</div>
                <div><strong>ä½ç½®:</strong> ${posText.lat.toFixed(6)}, ${posText.lng.toFixed(6)}</div>
                <div><strong>çŠ¶æ€:</strong> ${isLocationEnabled ? 'å®æ—¶æ›´æ–°ä¸­' : 'æ‰‹åŠ¨ä½ç½®'}</div>
            `;
        }

        function confirmLocation() {
            closeLocationModal();
            showNetworkStatus("ä½ç½®å·²ç¡®è®¤", 2000);
        }

        // ==================== ä½ç½®çŠ¶æ€æ›´æ–° ====================
        function updateLocationStatus(text) {
            const element = document.getElementById('locationText');
            if (element) element.textContent = text;
        }

        function updatePublishLocationDisplay() {
            const element = document.getElementById('publishLocationText');
            if (element) {
                const modeText = locationMode === 'gps' ? 'GPSå®šä½' : 'æ‰‹åŠ¨é€‰æ‹©';
                element.textContent = `ğŸ“ ${modeText} (${myPosition.lat.toFixed(4)}, ${myPosition.lng.toFixed(4)})`;
            }
        }

        function updateLocationDisplay() {
            updateLocationStatus(locationMode === 'gps' ? 'ğŸ“ GPSå®šä½ä¸­' : 'ğŸ¯ æ‰‹åŠ¨é€‰æ‹©');
            updatePublishLocationDisplay();
        }

        // ==================== WebSocket è¿æ¥ ====================
        function connectWebSocket() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                console.log("âœ… WebSocket å·²è¿æ¥");
                return;
            }

            console.log("ğŸ”Œ è¿æ¥æœåŠ¡å™¨:", WS_URL);
            showNetworkStatus("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...", 0);
            
            try {
                socket = new WebSocket(WS_URL);
            } catch (error) {
                console.error("âŒ åˆ›å»ºWebSocketå¤±è´¥:", error);
                updateConnectionStatus("âŒ è¿æ¥å¤±è´¥");
                showNetworkStatus("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ", 3000);
                return;
            }

            socket.onopen = () => {
                console.log("âœ… WebSocket è¿æ¥æˆåŠŸ");
                updateConnectionStatus("âœ… å·²è¿æ¥");
                showNetworkStatus("å·²è¿æ¥åˆ°æœåŠ¡å™¨", 2000);
                
                // â­ åªåœ¨å·²ç™»å½•çš„æƒ…å†µä¸‹å‘é€ä½ç½®ä¿¡æ¯
                if (currentUser && currentUser.id) {
                    sendLogin();
                    // å‘é€å½“å‰ä½ç½®
                    sendPositionToServer();
                }
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (error) {
                    console.error("âŒ æ¶ˆæ¯è§£æå¤±è´¥:", error);
                }
            };

            socket.onclose = () => {
                console.log("ğŸ“¡ è¿æ¥å·²å…³é—­");
                updateConnectionStatus("âŒ è¿æ¥æ–­å¼€");
                showNetworkStatus("ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥", 2000);
                
                // 3ç§’åé‡è¿
                setTimeout(() => {
                    if (currentUser) {
                        connectWebSocket();
                    }
                }, 3000);
            };

            socket.onerror = (error) => {
                console.error("âŒ WebSocketé”™è¯¯:", error);
                updateConnectionStatus("âŒ è¿æ¥é”™è¯¯");
                showNetworkStatus("è¿æ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•", 2000);
            };
        }

        function updateConnectionStatus(status) {
            const element = document.getElementById('connectionStatus');
            if (element) element.textContent = status;
        }


        function sendLogin() {
            if (!socket || socket.readyState !== WebSocket.OPEN || !currentUser) return;

            // ç¡®ä¿æœ‰ä½ç½®ä¿¡æ¯
            if (!myPosition) {
                myPosition = { lat: 31.28, lng: 121.50 }; // é»˜è®¤ä¸Šæµ·ä½ç½®
            }
            
            // ç¡®ä¿æœ‰èŒƒå›´ä¿¡æ¯
            if (!visibleRange) {
                visibleRange = 1000; // é»˜è®¤1000ç±³
            }
            
            socket.send(JSON.stringify({
                type: "login",
                userId: currentUser.id,
                nickname: currentUser.nickname,
                avatar: currentUser.avatar,
                lat: myPosition.lat,
                lng: myPosition.lng,
                range: visibleRange  // âœ… é‡è¦ï¼šå‘é€æˆ‘çš„å¯è§èŒƒå›´
            }));
            
            console.log("ğŸ“¤ å‘é€ç™»å½•ä¿¡æ¯:", currentUser.nickname, "èŒƒå›´:", visibleRange + "ç±³");
        }
        
        function sendPositionToServer() {
            if (!socket || socket.readyState !== WebSocket.OPEN || !currentUser) return;
            
            // ç¡®ä¿æœ‰ä½ç½®ä¿¡æ¯
            if (!myPosition) {
                console.log("âš ï¸ æ— ä½ç½®ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®");
                myPosition = { lat: 31.28, lng: 121.50 };
            }
            
            socket.send(JSON.stringify({
                type: "position",
                lat: myPosition.lat,
                lng: myPosition.lng,
                userId: currentUser.id,
                nickname: currentUser.nickname,
                range: visibleRange  // âœ… é‡è¦ï¼šå‘é€æˆ‘çš„å¯è§èŒƒå›´
            }));
            
            console.log("ğŸ“ å‘é€ä½ç½®ä¿¡æ¯:", myPosition, "èŒƒå›´:", visibleRange + "ç±³");
        }


        function requestNearbyBubbles() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                console.error("âŒ WebSocket æœªè¿æ¥");
                return;
            }
            
            if (!myPosition) {
                console.error("âŒ æ— ä½ç½®ä¿¡æ¯");
                return;
            }
            
            // è¯·æ±‚é™„è¿‘æ°”æ³¡
            socket.send(JSON.stringify({
                type: "getNearbyBubbles"
            }));
            
            console.log("ğŸ“¡ è¯·æ±‚é™„è¿‘æ°”æ³¡");
        }

        // ==================== æ¶ˆæ¯å¤„ç† ====================
        function handleServerMessage(data) {
            console.log("ğŸ“¨ æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯:", data.type, data);

            switch (data.type) {
                case "registerResponse":
                    // å¤„ç†æ³¨å†Œå“åº”
                    if (data.success) {
                        showAuthMessage(data.message || 'æ³¨å†ŒæˆåŠŸï¼', 'success');
                        setTimeout(() => {
                            switchAuthMode('login');
                            // è‡ªåŠ¨å¡«å……ç™»å½•ä¿¡æ¯
                            document.getElementById('loginId').value = data.user.id;
                        }, 1500);
                    } else {
                        showAuthMessage(data.message || 'æ³¨å†Œå¤±è´¥', 'error');
                    }
                    break;
                    
                case "loginSuccess":
                    // è®¤è¯ç™»å½•æˆåŠŸ
                    if (data.message) {
                        showAuthMessage(data.message, 'success');
                    }
                    // è®¾ç½®å½“å‰ç”¨æˆ·
                    currentUser = {
                        id: data.user.id,
                        nickname: data.user.nickname,
                        phone: data.user.phone,
                        avatar: data.user.avatar
                    };
                    
                    // éšè—ç™»å½•ç•Œé¢
                    setTimeout(() => {
                        hideAuthOverlay();
                        handleLoginSuccess(data.user);
                    }, 1000);
                    break;
                    
                case "loginFailed":
                    // ç™»å½•å¤±è´¥
                    showAuthMessage(data.message || 'ç™»å½•å¤±è´¥', 'error');
                    break;
                    
                case "onlineCount":
                    updateOnlineCount(data.count);
                    break;
                    
                case "newBubble":
                    console.log("ğŸˆ æ”¶åˆ°æ–°æ°”æ³¡å¹¿æ’­:", data.bubble);
                    addBubble(data.bubble);
                    break;
                    
                case "nearbyBubbles":
                    console.log("ğŸ“¦ æ”¶åˆ°é™„è¿‘æ°”æ³¡:", data.bubbles.length);
                    data.bubbles.forEach(bubble => addBubble(bubble));
                    break;
                    
                case "publicChat":
                    console.log("ğŸ’¬ æ”¶åˆ°èŠå¤©æ¶ˆæ¯:", data.from, data.msg);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼ˆé¿å…å›å£°ï¼‰
                    const isMyMessage = currentUser && 
                        (data.fromId === currentUser.id || data.from === currentUser.nickname);
                    
                    if (!isMyMessage) {
                        // åªæœ‰å…¶ä»–äººçš„æ¶ˆæ¯æ‰æ˜¾ç¤ºï¼Œè‡ªå·±çš„æ¶ˆæ¯å·²ç»åœ¨sendChatMessageä¸­æ˜¾ç¤ºäº†
                        addChatMessage({
                            from: data.from,
                            avatar: data.avatar,
                            text: data.msg,
                            time: data.time,
                            isMyMessage: false
                        });
                    }
                    break;
                    
                case "userPosition":
                    // æ›´æ–°å…¶ä»–ç”¨æˆ·çš„ä½ç½®ä¿¡æ¯
                    updateOtherUserPosition(data);
                    break;
                    
                case "onlineUsers":
                    // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                    updateOnlineUsersList(data.users);
                    break;
                    
                case "clearBubblesResponse":
                    console.log("âœ… æœåŠ¡å™¨å·²ç¡®è®¤æ¸…é™¤æ°”æ³¡:", data.message);
                    showNetworkStatus("æœåŠ¡å™¨å·²ç¡®è®¤æ¸…é™¤æ°”æ³¡", 2000);
                    // è¿™é‡Œå¯ä»¥åšä¸€äº›é¢å¤–çš„æ¸…ç†å·¥ä½œ
                    break;
                    
                case "bubblesCleared":
                    // æœåŠ¡å™¨é€šçŸ¥æ°”æ³¡å·²è¢«æ¸…é™¤
                    console.log("ğŸ¯ æœåŠ¡å™¨å·²æ¸…é™¤æ°”æ³¡");
                    // ä¸éœ€è¦å†åšä»€ä¹ˆï¼Œå› ä¸ºæœ¬åœ°å·²ç»æ¸…é™¤äº†
                    break;

                default:
                    console.log("âš ï¸ æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:", data.type);
            }
        }

        function handleLoginSuccess(user) {
            console.log("âœ… ç™»å½•æˆåŠŸ:", user);
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            if (!currentUser) {
                currentUser = {
                    id: user.id,
                    nickname: user.nickname || user.username,
                    avatar: user.avatar || 'ğŸ‘¤'
                };
            } else {
                currentUser.id = user.id;
            }
            
            // æ›´æ–°UIæ˜¾ç¤º
            document.getElementById('userNickname').textContent = currentUser.nickname;
            document.getElementById('userId').textContent = `ID: ${user.id}`;
            
            // ç¡®ä¿æˆ‘çš„ä½ç½®å·²è®¾ç½®
            if (!myPosition) {
                myPosition = user.lat && user.lng ? 
                    { lat: user.lat, lng: user.lng } : 
                    { lat: 39.9042, lng: 116.4074 };
            }
            
            // æ›´æ–°æˆ‘çš„ä½ç½®æ ‡è®°å’ŒèŒƒå›´åœ†åœˆ
            updateMyMarker();
            updateMyRange();
            
            // åˆ·æ–°æ‰€æœ‰æ ‡è®°
            refreshAllMarkers();
            
            // è¯·æ±‚é™„è¿‘æ°”æ³¡
            setTimeout(() => {
                requestNearbyBubbles();
            }, 500);
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            if (typeof window.showWelcomeMessage === 'function') {
                window.showWelcomeMessage();
            }
        }

        function updateOnlineCount(count) {
            console.log("ğŸ‘¥ åœ¨çº¿äººæ•°:", count);
            // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°åœ¨çº¿äººæ•°æ˜¾ç¤º
        }

        function updateOnlineUsersList(users) {
            const container = document.getElementById('onlineUsersList');
            if (!container) return;
            
            // æ¸…ç©ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            onlineUsers = {};
            
            if (users && users.length > 0) {
                // æ›´æ–°åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
                users.forEach(user => {
                    onlineUsers[user.userId] = {
                        lat: user.lat,
                        lng: user.lng,
                        nickname: user.nickname,
                        range: user.range || 1000  // âœ… ç¡®ä¿æœ‰èŒƒå›´ä¿¡æ¯
                    };
                });
                
                // åˆ·æ–°æ ‡è®°
                refreshAllMarkers();  // âœ… é‡è¦ï¼šæ›´æ–°åç«‹å³åˆ·æ–°æ ‡è®°
                
                // æ›´æ–°UIåˆ—è¡¨
                container.innerHTML = users.map(user => `
                    <div class="user-item">
                        <span style="color: #5483B3">ğŸ‘¤</span>
                        <span>${user.nickname}</span>
                        <span style="font-size: 12px; color: #666">
                            ${user.lat ? `(${user.lat.toFixed(4)}, ${user.lng.toFixed(4)})` : '(ä½ç½®æœªçŸ¥)'}
                            <br>èŒƒå›´: ${user.range || 1000}ç±³
                        </span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="user-item"><span style="color: #5483B3">ğŸ‘¤</span><span>æš‚æ— å…¶ä»–åœ¨çº¿ç”¨æˆ·</span></div>';
            }
        }


        function updateOtherUserPosition(data) {
            if (!data.userId) return;
            
            // å¦‚æœæ˜¯è‡ªå·±ï¼Œè·³è¿‡
            if (currentUser && data.userId === currentUser.id) {
                return;
            }
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            onlineUsers[data.userId] = {
                lat: data.lat,
                lng: data.lng,
                nickname: data.nickname,
                range: data.range || 1000
            };
            
            // åˆ·æ–°æ ‡è®°
            refreshAllMarkers();
            
            console.log(`ğŸ“ æ›´æ–°ç”¨æˆ·ä½ç½®: ${data.nickname} (${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`);
        }

        // ==================== æ°”æ³¡åŠŸèƒ½ ====================
        function selectBubbleType(type) {
            selectedBubbleType = type;
            
            // æ›´æ–°UI
            document.querySelectorAll('.bubble-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            console.log("âœ… é€‰æ‹©æ°”æ³¡ç±»å‹:", type);
        }

        function publishBubble() {
            const title = document.getElementById('bubbleTitle').value.trim();
            const content = document.getElementById('bubbleContent').value.trim();
            
            if (!title) {
                showNetworkStatus("è¯·è¾“å…¥æ°”æ³¡æ ‡é¢˜", 2000);
                return;
            }
            
            if (!currentUser) {
                showNetworkStatus("è¯·å…ˆç™»å½•", 2000);
                return;
            }
            
            // ä½¿ç”¨å½“å‰é€‰æ‹©çš„ä½ç½®
            const publishPosition = myPosition;
            
            // âœ… ä½¿ç”¨æ­£ç¡®çš„æ¶ˆæ¯æ ¼å¼ï¼špublishBubble
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "publishBubble",
                    bubbleType: selectedBubbleType,
                roomCode: selectedBubbleType === 'group' ? generateChatroomCode() : null,  // â­ å»ºç¾¤ç±»å‹ç”ŸæˆèŠå¤©å®¤ä»£ç 
                    title: title,
                    content: content,
                    lat: publishPosition.lat,
                    lng: publishPosition.lng,
                    duration: 3600,
                    activityTags: []
                }));
                
                console.log("ğŸ“¤ å‘é€æ°”æ³¡(publishBubble):", {title, type: selectedBubbleType});
                showNetworkStatus("æ°”æ³¡å‘å¸ƒæˆåŠŸï¼", 2000);
            }
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('bubbleTitle').value = '';
            document.getElementById('bubbleContent').value = '';
        }


        function addBubble(bubble) {
            // æ£€æŸ¥æ¸…é™¤æ ‡è®°
            if (window.clearBubblesFlag) {
                console.log("ğŸš« æ¸…é™¤æ¨¡å¼ä¸­ï¼Œå¿½ç•¥æ–°æ°”æ³¡:", bubble.id);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingBubble = bubbles.find(b => b.id === bubble.id);
            if (existingBubble) {
                console.log("âš ï¸ æ°”æ³¡å·²å­˜åœ¨ï¼Œè·³è¿‡:", bubble.id);
                return;
            }

            // â­ å…³é”®ï¼šå»ºç¾¤æ°”æ³¡çš„roomCodeåº”è¯¥ç”±æœåŠ¡å™¨æä¾›
            if (bubble.type === 'group') {
                if (!bubble.roomCode) {
                    console.error("âŒ å»ºç¾¤æ°”æ³¡ç¼ºå°‘roomCodeï¼");
                    console.error("   æ°”æ³¡ID:", bubble.id);
                    console.error("   è¿™ä¸ªæ°”æ³¡æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ç«¯ä»£ç ");
                    console.error("   æœåŠ¡å™¨éœ€è¦ä¿å­˜å®¢æˆ·ç«¯å‘é€çš„roomCode");
                    // ä¸å†è‡ªåŠ¨ç”Ÿæˆï¼Œé¿å…æ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆä¸åŒçš„ä»£ç 
                } else {
                    console.log("âœ… å»ºç¾¤æ°”æ³¡roomCode:", bubble.roomCode);
                }
            }
            
            // ç¡®ä¿æ°”æ³¡æœ‰å¿…è¦çš„å­—æ®µ
            if (!bubble.createdAt) {
                bubble.createdAt = Date.now();
            }
            if (!bubble.time) {
                bubble.time = bubble.createdAt;
            }
            
            // æ·»åŠ åˆ°åˆ—è¡¨
            bubbles.push(bubble);
            
            // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤º
            const label = addBubbleToMap(bubble);
            
            if (label) {
                console.log("âœ… æˆåŠŸæ·»åŠ æ°”æ³¡åˆ°åœ°å›¾:", bubble.title);
                showNetworkStatus(`æ”¶åˆ°æ–°æ°”æ³¡: ${bubble.title}`, 2000);
            } else {
                console.error("âŒ æ·»åŠ æ°”æ³¡åˆ°åœ°å›¾å¤±è´¥:", bubble.title);
            }
            
            return bubble;
        }

        // æ˜¾ç¤ºé•¿æŒ‰æç¤º
        let currentHint = null;

        function showLongPressHint(bubbleTitle, position) {
            // ç§»é™¤ç°æœ‰çš„æç¤º
            hideLongPressHint();
            
            // åˆ›å»ºæç¤ºå…ƒç´ 
            currentHint = document.createElement('div');
            currentHint.className = 'long-press-hint';
            currentHint.textContent = `é•¿æŒ‰æ˜¾ç¤º ${bubbleTitle} è¯¦æƒ…`;
            
            // è®¡ç®—ä½ç½®
            const pixelPosition = map.getProjection().fromLatLngToContainerPixel(position);
            currentHint.style.left = (pixelPosition.x + 10) + 'px';
            currentHint.style.top = (pixelPosition.y + 60) + 'px';
            
            document.body.appendChild(currentHint);
        }

        // éšè—é•¿æŒ‰æç¤º
        function hideLongPressHint() {
            if (currentHint) {
                currentHint.remove();
                currentHint = null;
            }
        }


        function getBubbleTypeName(type) {
            const names = {
                recommend: 'æ¨è',
                help: 'æ±‚åŠ©',
                team: 'ç»„é˜Ÿ',
                warning: 'é¿é›·',
                news: 'è§é—»'
            };
            return names[type] || type;
        }


            
        function addBubbleToMap(bubble) {
            if (!map) {
                console.warn("åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ·»åŠ æ°”æ³¡");
                return;
            }
            
            // æ°”æ³¡å›¾æ ‡æ˜ å°„
            const icons = {
                recommend: 'ğŸ‘',
                help: 'ğŸ†˜',
                team: 'ğŸ‘¥',
                warning: 'âš ï¸',
                news: 'ğŸ“°',
                group: 'ğŸ’¬'
            };
            
            const icon = icons[bubble.type] || 'ğŸ“';
            
            // åˆ›å»ºæ°”æ³¡æ ‡ç­¾
            const label = new qq.maps.Label({
                position: new qq.maps.LatLng(bubble.lat, bubble.lng),
                map: map,
                content: `<div class="bubble bubble-${bubble.type}" 
                        data-bubble-id="${bubble.id}"
                        style="cursor: pointer;"
                        title="é•¿æŒ‰2ç§’æŸ¥çœ‹è¯¦æƒ…">${icon}</div>`,
                style: { border: 'none', background: 'transparent' }
            });
            
            console.log(`ğŸ¯ åˆ›å»ºæ°”æ³¡æ ‡ç­¾: ${bubble.title}, ä½ç½®: ${bubble.lat}, ${bubble.lng}`);
            
            // é•¿æŒ‰è®¡æ—¶å™¨
            let longPressTimer = null;
            let isLongPressing = false;
            
            // ç‚¹å‡»äº‹ä»¶ - ç”¨äºè°ƒè¯•å’Œå¿«é€ŸæŸ¥çœ‹
            qq.maps.event.addListener(label, 'click', function(e) {
                console.log(`ğŸ‘† ç‚¹å‡»æ°”æ³¡: ${bubble.title}`);
                // ä»ç„¶å¯ä»¥ç‚¹å‡»ï¼Œä½†æ˜¾ç¤ºæç¤º
                showNetworkStatus(`é•¿æŒ‰2ç§’æŸ¥çœ‹ ${bubble.title} çš„è¯¦ç»†ä¿¡æ¯`, 2000);
            });
            
            // è§¦æ‘¸å¼€å§‹äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
            qq.maps.event.addListener(label, 'touchstart', function(e) {
                console.log(`ğŸ–ï¸ è§¦æ‘¸å¼€å§‹: ${bubble.title}`);
                
                // åªé˜»æ­¢å†’æ³¡ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
                if (e && e.domEvent) {
                    e.domEvent.stopPropagation();
                }
                
                // å¼€å§‹é•¿æŒ‰è®¡æ—¶
                longPressTimer = setTimeout(function() {
                    console.log(`â±ï¸ é•¿æŒ‰å®Œæˆ: ${bubble.title}`);
                    isLongPressing = true;
                    showBubbleInfoWindow(bubble, label);
                    
                    // æ·»åŠ é•¿æŒ‰åé¦ˆæ•ˆæœ
                    const bubbleEl = document.querySelector(`[data-bubble-id="${bubble.id}"]`);
                    if (bubbleEl) {
                        bubbleEl.classList.add('marker-pressing');
                    }
                    
                    // æ˜¾ç¤ºé•¿æŒ‰æç¤º
                    showLongPressHint(bubble.title, label.getPosition());
                }, 2000); // 2ç§’é•¿æŒ‰
            });
            
            // è§¦æ‘¸ç»“æŸäº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
            qq.maps.event.addListener(label, 'touchend', function(e) {
                console.log(`ğŸ–ï¸ è§¦æ‘¸ç»“æŸ: ${bubble.title}`);
                
                // æ¸…é™¤è®¡æ—¶å™¨
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // ç§»é™¤é•¿æŒ‰åé¦ˆæ•ˆæœ
                const bubbleEl = document.querySelector(`[data-bubble-id="${bubble.id}"]`);
                if (bubbleEl) {
                    bubbleEl.classList.remove('marker-pressing');
                }
                
                // ç§»é™¤æç¤º
                hideLongPressHint();
            });
            
            // è§¦æ‘¸å–æ¶ˆäº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
            qq.maps.event.addListener(label, 'touchcancel', function() {
                console.log(`âŒ è§¦æ‘¸å–æ¶ˆ: ${bubble.title}`);
                
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                const bubbleEl = document.querySelector(`[data-bubble-id="${bubble.id}"]`);
                if (bubbleEl) {
                    bubbleEl.classList.remove('marker-pressing');
                }
                
                hideLongPressHint();
            });
            
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
            qq.maps.event.addListener(label, 'mousedown', function(e) {
                console.log(`ğŸ–±ï¸ é¼ æ ‡æŒ‰ä¸‹: ${bubble.title}`);
                
                // åªé˜»æ­¢å†’æ³¡
                if (e && e.domEvent) {
                    e.domEvent.stopPropagation();
                }
                
                longPressTimer = setTimeout(function() {
                    console.log(`â±ï¸ æ¡Œé¢ç«¯é•¿æŒ‰å®Œæˆ: ${bubble.title}`);
                    isLongPressing = true;
                    showBubbleInfoWindow(bubble, label);
                    
                    // æ·»åŠ é•¿æŒ‰åé¦ˆæ•ˆæœ
                    const bubbleEl = document.querySelector(`[data-bubble-id="${bubble.id}"]`);
                    if (bubbleEl) {
                        bubbleEl.classList.add('marker-pressing');
                    }
                    
                    // æ˜¾ç¤ºé•¿æŒ‰æç¤º
                    showLongPressHint(bubble.title, label.getPosition());
                }, 2000);
            });
            
            // é¼ æ ‡æ¾å¼€äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
            qq.maps.event.addListener(label, 'mouseup', function(e) {
                console.log(`ğŸ–±ï¸ é¼ æ ‡æ¾å¼€: ${bubble.title}`);
                
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // ç§»é™¤é•¿æŒ‰åé¦ˆæ•ˆæœ
                const bubbleEl = document.querySelector(`[data-bubble-id="${bubble.id}"]`);
                if (bubbleEl) {
                    bubbleEl.classList.remove('marker-pressing');
                }
                
                // ç§»é™¤æç¤º
                hideLongPressHint();
            });
            
            // é¼ æ ‡ç¦»å¼€äº‹ä»¶ï¼ˆé˜²æ­¢æ‹–åŠ¨åœ°å›¾æ—¶è§¦å‘é•¿æŒ‰ï¼‰
            qq.maps.event.addListener(label, 'mouseout', function() {
                console.log(`ğŸšª é¼ æ ‡ç¦»å¼€: ${bubble.title}`);
                
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                const bubbleEl = document.querySelector(`[data-bubble-id="${bubble.id}"]`);
                if (bubbleEl) {
                    bubbleEl.classList.remove('marker-pressing');
                }
                
                hideLongPressHint();
            });
            
            // ä¿å­˜æ ‡è®°å¼•ç”¨
            bubbleMarkers.set(bubble.id, { bubble, label });
            
            console.log(`âœ… æ°”æ³¡å·²æˆåŠŸæ·»åŠ åˆ°åœ°å›¾: ${bubble.title}`);
            return label;
        }


        // æ˜¾ç¤ºæ°”æ³¡ä¿¡æ¯çª—å£
        // æ˜¾ç¤ºæ°”æ³¡ä¿¡æ¯çª—å£ï¼ˆé•¿æŒ‰2ç§’åè§¦å‘ï¼‰
        function showBubbleInfoWindow(bubble, label) {
            console.log(`ğŸªŸ æ˜¾ç¤ºæ°”æ³¡ä¿¡æ¯çª—å£: ${bubble.title}`);
            
            // å…³é—­ç°æœ‰çš„ä¿¡æ¯çª—å£
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
            
            const typeNames = {
                recommend: 'æ¨è',
                help: 'æ±‚åŠ©',
                team: 'ç»„é˜Ÿ',
                warning: 'é¿é›·',
                news: 'è§é—»',
                group: 'ğŸ’¬ å»ºç¾¤'
            };
            
            const typeName = typeNames[bubble.type] || bubble.type;
            
            // æ·»åŠ æˆ¿é—´ä»£ç æ˜¾ç¤º
            const roomCodeDisplay = bubble.type === 'group' && bubble.roomCode ? 
                `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #FFD700;">
                    <div style="font-weight: 600; color: #052659; margin-bottom: 5px;">ğŸ’¬ ç¾¤èŠä»£ç </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 20px; color: #052659; letter-spacing: 2px; text-align: center; padding: 8px;">
                        ${bubble.roomCode}
                    </div>
                    <button onclick="setChatroomCode('${bubble.roomCode}')" 
                            style="width: 100%; padding: 8px; margin-top: 8px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border: none; border-radius: 6px; color: #052659; font-weight: 600; cursor: pointer;"
                            onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(255, 215, 0, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
                        åŠ å…¥æ­¤ç¾¤èŠ
                    </button>
                </div>` : '';
            
            // â­ å…³é”®ä¿®å¤ï¼šåˆ›å»ºæ­£ç¡®çš„HTMLå†…å®¹
            const content = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 15px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    min-width: 250px;
                    max-width: 350px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                ">
                    <button onclick="closeBubbleInfoWindow()" 
                            style="position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; border-radius: 50%; background: rgba(0,0,0,0.1); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #666; transition: all 0.2s;"
                            onmouseover="this.style.background='rgba(0,0,0,0.2)';this.style.color='#000';"
                            onmouseout="this.style.background='rgba(0,0,0,0.1)';this.style.color='#666';">
                        Ã—
                    </button>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
                        <div style="font-size: 16px; font-weight: 600; color: #052659;">${escapeHtml(bubble.title)}</div>
                        <span style="padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; color: white; background: ${getBubbleColor(bubble.type)};">${typeName}</span>
                    </div>
                    ${roomCodeDisplay}
                    ${bubble.content ? `<div style="color: #495057; font-size: 14px; line-height: 1.6; margin: 10px 0;">${escapeHtml(bubble.content)}</div>` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; font-size: 12px; color: #6c757d;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span>${bubble.avatar || 'ğŸ‘¤'}</span>
                            <span>${escapeHtml(bubble.author || 'åŒ¿å')}</span>
                        </div>
                        <div>${formatTime(bubble.createdAt || Date.now())}</div>
                    </div>
                    <div style="font-size: 11px; color: #6c757d; text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0;">
                        10ç§’åè‡ªåŠ¨å…³é—­ï¼Œæˆ–ç‚¹å‡»Ã—å…³é—­
                    </div>
                </div>
            `;
            
            try {
                console.log(`ğŸ“ æ°”æ³¡ä½ç½®: ${bubble.lat}, ${bubble.lng}`);
                
                // è·å–æ ‡ç­¾çš„ä½ç½®
                const labelPosition = label.getPosition();
                console.log(`ğŸ“ æ ‡ç­¾ä½ç½®: ${labelPosition.getLat()}, ${labelPosition.getLng()}`);
                
                // åˆ›å»ºä¿¡æ¯çª—å£
                const infoWindow = new qq.maps.InfoWindow({
                    map: map,
                    position: labelPosition,
                    content: content
                });
                
                // æ‰“å¼€ä¿¡æ¯çª—å£
                infoWindow.open();
                currentInfoWindow = infoWindow;
                
                console.log("âœ… æ°”æ³¡ä¿¡æ¯çª—å£å·²æ‰“å¼€");
                
                // é«˜äº®é€‰ä¸­çš„æ°”æ³¡
                document.querySelectorAll('.bubble').forEach(el => el.classList.remove('active'));
                const bubbleEl = document.querySelector(`[data-bubble-id="${bubble.id}"]`);
                if (bubbleEl) {
                    bubbleEl.classList.add('active');
                    console.log("âœ¨ æ°”æ³¡é«˜äº®");
                }
                
                // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€æç¤º
                showNetworkStatus(`å·²æ˜¾ç¤ºæ°”æ³¡è¯¦æƒ…ï¼š${bubble.title}`, 2000);
                
                // 10ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (currentInfoWindow === infoWindow) {
                        closeBubbleInfoWindow();
                    }
                }, 10000);
                
                return infoWindow;
                
            } catch (error) {
                console.error("âŒ åˆ›å»ºä¿¡æ¯çª—å£å¤±è´¥:", error);
                showNetworkStatus("æ— æ³•æ˜¾ç¤ºæ°”æ³¡ä¿¡æ¯", 2000);
                return null;
            }
        }


        function closeBubbleInfoWindow() {
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
            // ç§»é™¤æ‰€æœ‰æ°”æ³¡çš„é«˜äº®çŠ¶æ€
            document.querySelectorAll('.bubble').forEach(el => el.classList.remove('active'));
        }


        function getBubbleIcon(type) {
            const emojis = {
                recommend: 'ğŸ‘',
                help: 'ğŸ†˜',
                team: 'ğŸ‘¥',
                warning: 'âš ï¸',
                news: 'ğŸ“°'
            };
            
            const emoji = emojis[type] || 'ğŸˆ';
            const color = getBubbleColor(type);
            
            // åˆ›å»ºSVGå›¾æ ‡
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                    <circle cx="24" cy="24" r="22" fill="${color}" stroke="white" stroke-width="3"/>
                    <text x="24" y="32" text-anchor="middle" fill="white" font-size="24" font-family="Arial">${emoji}</text>
                </svg>
            `;
            
            return new qq.maps.MarkerImage(
                'data:image/svg+xml;utf8,' + encodeURIComponent(svg),
                new qq.maps.Size(48, 48),
                new qq.maps.Point(0, 0),
                new qq.maps.Point(24, 24)
            );
        }

        function getBubbleColor(type) {
            const colors = {
                recommend: '#FF4444',
                help: '#FFD700',
                team: '#4169E1',
                warning: '#9932CC',
                news: '#FF69B4'
            };
            return colors[type] || '#5483B3';
        }


        function showBubbleInfo(bubble) {
            let roomCodeInfo = '';
            if (bubble.type === 'group' && bubble.roomCode) {
                roomCodeInfo = `\nğŸ’¬ ç¾¤èŠä»£ç : ${bubble.roomCode}\nç‚¹å‡»"åŠ å…¥æ­¤ç¾¤èŠ"å³å¯è¿›å…¥`;
            }
            
            const info = `
        ğŸˆ æ°”æ³¡è¯¦æƒ…ï¼š
        æ ‡é¢˜ï¼š${bubble.title}
        ç±»å‹ï¼š${getBubbleTypeName(bubble.type)}
        ä½œè€…ï¼š${bubble.author}
        å†…å®¹ï¼š${bubble.content || "æ— å†…å®¹"}
        æ—¶é—´ï¼š${formatTime(bubble.time)}
        ä½ç½®ï¼š${bubble.lat.toFixed(4)}, ${bubble.lng.toFixed(4)}
        ${roomCodeInfo}
            `;
            
            showNetworkStatus(info, 4000);
        }

        function clearAllBubbles() {
            console.log("ğŸ—‘ï¸ å¼€å§‹æ¸…é™¤æ‰€æœ‰æ°”æ³¡");
            
            // è®¾ç½®æ¸…é™¤æ ‡è®°ï¼Œé˜²æ­¢æ–°æ°”æ³¡è¢«æ·»åŠ 
            clearBubblesFlag = true;
            
            // 10ç§’åè‡ªåŠ¨è§£é™¤æ¸…é™¤æ¨¡å¼
            if (clearTimeoutId) clearTimeout(clearTimeoutId);
            clearTimeoutId = setTimeout(() => {
                clearBubblesFlag = false;
                console.log("ğŸ”„ è‡ªåŠ¨è§£é™¤æ¸…é™¤æ¨¡å¼");
            }, 10000);
            
            // 1. å…ˆå‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨æ¸…é™¤æ°”æ³¡
            if (socket && socket.readyState === WebSocket.OPEN && currentUser) {
                socket.send(JSON.stringify({
                    type: "clearBubbles",
                    userId: currentUser.id,
                    clearAll: true
                }));
                console.log("ğŸ“¤ å·²å‘é€æ¸…é™¤æ°”æ³¡è¯·æ±‚åˆ°æœåŠ¡å™¨");
            }
            
            // 2. ä»åœ°å›¾ä¸Šç§»é™¤æ‰€æœ‰æ°”æ³¡æ ‡è®°
            bubbleMarkers.forEach((markerInfo, bubbleId) => {
                if (markerInfo.label) {
                    markerInfo.label.setMap(null);
                }
            });
            
            // 3. æ¸…ç©ºå­˜å‚¨
            bubbleMarkers.clear();
            bubbles.length = 0;
            
            // 4. æ›´æ–°UI
            updateBubblesList();
            
            // 5. å…³é—­ä¿¡æ¯çª—å£
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
            
            console.log("âœ… æ°”æ³¡æ¸…é™¤å®Œæˆï¼ˆé”å®š10ç§’ï¼‰");
            showNetworkStatus("å·²æ¸…é™¤æ°”æ³¡ï¼Œ10ç§’å†…ä¸ä¼šæ¥æ”¶æ–°æ°”æ³¡", 3000);
        }

        // æ·»åŠ è§£é™¤æ¸…é™¤æ¨¡å¼çš„å‡½æ•°
        function enableBubbleReceiving() {
            clearBubblesFlag = false;
            if (clearTimeoutId) {
                clearTimeout(clearTimeoutId);
                clearTimeoutId = null;
            }
            console.log("ğŸ”„ å·²å¯ç”¨æ°”æ³¡æ¥æ”¶");
            showNetworkStatus("å·²æ¢å¤æ¥æ”¶æ–°æ°”æ³¡", 2000);
        }   
  


                // ==================== å…¬å±èŠå¤©åŠŸèƒ½ ====================
        function toggleChatPanel() {
            chatPanelVisible = !chatPanelVisible;
            const panel = document.getElementById('chatPanel');
            const toggleBtn = document.getElementById('chatToggleBtn');
            
            if (chatPanelVisible) {
                panel.style.display = 'flex';
                toggleBtn.style.display = 'none';
                unreadCount = 0;
                updateChatBadge();
                document.getElementById('chatInput').focus();
            } else {
                panel.style.display = 'none';
                toggleBtn.style.display = 'flex';
            }
        }

        function handleChatInputKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

      function sendChatMessage() {
    const input = document.getElementById('chatInput');
    let text = input.value.trim();
    
    if (!text) return;
    
    if (!currentUser) {
        showNetworkStatus("è¯·å…ˆç™»å½•", 2000);
        return;
    }
    
    // â­ ä¿®å¤ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æœ‰æœ‰æ•ˆå†…å®¹
    const prefixMatch = text.match(/^\[(\d{6})\]\s+/);
    
    if (prefixMatch) {
        // æœ‰å‰ç¼€ï¼Œæ£€æŸ¥å‰ç¼€åçš„å†…å®¹æ˜¯å¦ä¸ºç©º
        const actualContent = text.substring(prefixMatch[0].length).trim();
        if (!actualContent) {
            showNetworkStatus("æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º", 2000);
            return;
        }
    } else {
        // æ²¡æœ‰å‰ç¼€ï¼Œè‡ªåŠ¨æ·»åŠ [000000]
        text = '[000000] ' + text;
        console.log('â­ è‡ªåŠ¨æ·»åŠ [000000]å‰ç¼€:', text);
    }
    
    // ç”Ÿæˆæ¶ˆæ¯IDç”¨äºé˜²æ­¢å›å£°
    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    sentMessageIds.add(messageId);
    
    // ç«‹å³åœ¨æœ¬åœ°æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
    addChatMessage({
        id: messageId,
        from: currentUser.nickname,
        avatar: currentUser.avatar,
        text: text,
        time: Date.now(),
        isMyMessage: true
    });
    
    // âœ… ä½¿ç”¨æ­£ç¡®çš„æ¶ˆæ¯æ ¼å¼ï¼špublicChat
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: "publicChat",
            msg: text,
            messageId: messageId
        }));
        
        console.log("ğŸ“¤ å‘é€èŠå¤©æ¶ˆæ¯:", text);
    }
    
    input.value = '';
    
    // â­ å¦‚æœåœ¨èŠå¤©å®¤æ¨¡å¼ï¼Œé‡æ–°æ·»åŠ å‰ç¼€
    if (currentChatroomCode !== '000000') {
        input.value = '[' + currentChatroomCode + '] ';
    }
    
    input.focus();
}
function addChatMessage(message) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
    if (message.id && sentMessageIds.has(message.id)) {
        console.log("âš ï¸ æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡:", message.id);
        return;
    }
    
    // â­ ç³»ç»Ÿæ¶ˆæ¯å§‹ç»ˆæ˜¾ç¤º
    if (message.isSystem) {
        console.log('ğŸ” ç³»ç»Ÿæ¶ˆæ¯ï¼Œå§‹ç»ˆæ˜¾ç¤º:', message.text);
        chatMessages.push(message);
        if (chatMessages.length > 100) {
            chatMessages = chatMessages.slice(-100);
        }
        updateChatMessages();
        return;
    }
    
    // â­ æ ¸å¿ƒé€»è¾‘2ï¼šæ¶ˆæ¯ç­›é€‰
    const text = message.text || '';
    console.log('ğŸ” å¤„ç†æ¶ˆæ¯:', text, 'å½“å‰èŠå¤©å®¤ä»£ç :', currentChatroomCode);
    
    const prefixMatch = text.match(/^\[(\d{6})\]\s+/);
    
    if (prefixMatch) {
        const messageRoomCode = prefixMatch[1];
        const actualContent = text.substring(prefixMatch[0].length).trim();
        
        console.log('ğŸ” æå–çš„æˆ¿é—´ä»£ç :', messageRoomCode, 'å®é™…å†…å®¹:', actualContent);
        
        // â­ ä¿®å¤ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æœ‰å®é™…å†…å®¹
        if (!actualContent) {
            console.log('âš ï¸ æ¶ˆæ¯åªæœ‰å‰ç¼€æ— å†…å®¹ï¼Œè·³è¿‡');
            return;
        }
        
        // å½“å‰èŠå¤©ä»£ç ä¸º000000ï¼ˆå…¬å±ï¼‰ï¼šåªæ˜¾ç¤º[000000]çš„æ¶ˆæ¯
        if (currentChatroomCode === '000000') {
            if (messageRoomCode !== '000000') {
                console.log('â­ï¸ å…¬å±æ¨¡å¼ï¼Œè¿‡æ»¤èŠå¤©å®¤æ¶ˆæ¯ [' + messageRoomCode + ']');
                return;
            }
        } else {
            // å½“å‰èŠå¤©ä»£ç é000000ï¼ˆèŠå¤©å®¤ï¼‰ï¼šæ˜¾ç¤º[000000]æˆ–å½“å‰èŠå¤©å®¤çš„æ¶ˆæ¯
            if (messageRoomCode !== '000000' && messageRoomCode !== currentChatroomCode) {
                console.log('â­ï¸ èŠå¤©å®¤[' + currentChatroomCode + ']æ¨¡å¼ï¼Œè¿‡æ»¤å…¶ä»–èŠå¤©å®¤æ¶ˆæ¯ [' + messageRoomCode + ']');
                return;
            }
        }
    } else {
        // æ²¡æœ‰å‰ç¼€çš„æ¶ˆæ¯ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‡ºç°ï¼Œä½†å…¼å®¹å¤„ç†ï¼‰
        console.log('âš ï¸ æ”¶åˆ°æ— å‰ç¼€æ¶ˆæ¯ï¼ˆå…¼å®¹æ˜¾ç¤ºï¼‰:', text);
        // æ— å‰ç¼€æ¶ˆæ¯åº”è¯¥è¢«è¿‡æ»¤ï¼Œé™¤éç‰¹åˆ«å¤„ç†
        return;
    }
    
    // æ·»åŠ åˆ°åˆ—è¡¨
    chatMessages.push(message);
    
    // ä¿æŒæœ€å¤š100æ¡æ¶ˆæ¯
    if (chatMessages.length > 100) {
        chatMessages = chatMessages.slice(-100);
    }
    
    // æ›´æ–°UI
    updateChatMessages();
    
    // æœªè¯»æ¶ˆæ¯æç¤º
    if (!chatPanelVisible && !message.isMyMessage) {
        unreadCount++;
        updateChatBadge();
    }
    
    console.log("ğŸ’¬ æ·»åŠ èŠå¤©æ¶ˆæ¯:", message.from, message.text);
}

        function updateChatMessages() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = chatMessages.map(msg => {
                const messageClass = msg.isMyMessage ? 'chat-message my-message' : 'chat-message';
                const senderName = msg.isMyMessage ? 'æˆ‘' : msg.from;
                const avatar = msg.isMyMessage ? 'ğŸ‘¤' : (msg.avatar || 'ğŸ‘¤');
                
                // â­ è§£ææ¶ˆæ¯å‰ç¼€
                const text = msg.text || '';
                const prefixMatch = text.match(/^\[(\d{6})\]\s+/);
                let roomCode = null;
                let actualMessage = text;
                let roomBadge = '';
                let messageStyle = 'color: #052659; font-size: 13px;';
                
                if (prefixMatch) {
                    roomCode = prefixMatch[1];
                    actualMessage = text.substring(prefixMatch[0].length);
                    
                    if (roomCode === '000000') {
                        // å…¬å±æ¶ˆæ¯ - è“è‰²
                        roomBadge = '<span style="background: #5483B3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px;">ğŸ“¢ å…¬å±</span>';
                    } else {
                        // èŠå¤©å®¤æ¶ˆæ¯ - é‡‘è‰²
                        roomBadge = '<span style="background: #FFD700; color: #052659; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px;">ğŸ’¬ [' + roomCode + ']</span>';
                    }
                }
                
                return `
                    <div class="${messageClass}">
                        <div class="sender">${roomBadge}${avatar} ${senderName}</div>
                        <div style="${messageStyle}">${escapeHtml(actualMessage)}</div>
                        <div class="time">${formatTime(msg.time, true)}</div>
                    </div>
                `;
            }).join('');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        function updateChatBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp, showSeconds = false) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // å¦‚æœæ˜¯ä»Šå¤©
            if (diff < 24 * 60 * 60 * 1000) {
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = showSeconds ? ':' + date.getSeconds().toString().padStart(2, '0') : '';
                return `${hours}:${minutes}${seconds}`;
            }
            
            // å¦‚æœæ˜¯ä»Šå¹´
            if (date.getFullYear() === now.getFullYear()) {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}-${day}`;
            }
            
            return date.toLocaleDateString();
        }

        function showNetworkStatus(message, duration = 3000) {
            const status = document.getElementById('networkStatus');
            status.textContent = message;
            status.classList.add('show');
            
            if (duration > 0) {
                setTimeout(() => {
                    status.classList.remove('show');
                }, duration);
            }
        }

        // ==================== æµ‹è¯•å‡½æ•° ====================
        function loginTestUser() {
            // ä½¿ç”¨æµ‹è¯•è´¦å·å¿«é€Ÿç™»å½•
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'authLogin',
                    loginId: 'testuser',
                    password: '123456'
                }));
                
                console.log("ğŸ‘¤ å°è¯•ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•...");
                showNetworkStatus("æ­£åœ¨ç™»å½•æµ‹è¯•è´¦å·...", 2000);
            } else {
                showNetworkStatus("WebSocketæœªè¿æ¥ï¼Œè¯·ç¨åé‡è¯•", 2000);
            }
        }
    
// ==================== èŠå¤©å®¤åŠŸèƒ½æ¨¡å— ====================

/**
 * å½“å‰èŠå¤©å®¤ä»£ç 
 * é»˜è®¤ä¸º "000000" è¡¨ç¤ºä¸åœ¨ä»»ä½•èŠå¤©å®¤ï¼ˆå…¬å±æ¨¡å¼ï¼‰
 */

/**
 * ç”Ÿæˆ6ä½éšæœºèŠå¤©å®¤ä»£ç ï¼ˆéå…¨0ï¼‰
 * @returns {string} 6ä½æ•°å­—èŠå¤©å®¤ä»£ç 
 */
function generateChatroomCode() {
    let code;
    do {
        code = String(Math.floor(100000 + Math.random() * 900000));
    } while (code === "000000");
    return code;
}

/**
 * æ›´æ–°èŠå¤©å®¤ä»£ç 
 * å½“ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹èŠå¤©å®¤ä»£ç è¾“å…¥æ¡†æ—¶è°ƒç”¨
 */

function updateChatroomCode() {
    const input = document.getElementById('chatroomCodeInput');
    if (!input) return;
    
    let code = input.value.trim();
    
    // ç©ºå€¼è‡ªåŠ¨è®¾ç½®ä¸º000000
    if (code.length === 0) {
        code = "000000";
    }
    
    // éªŒè¯æ ¼å¼ï¼ˆå¿…é¡»æ˜¯6ä½æ•°å­—ï¼‰
    if (!/^\d{6}$/.test(code)) {
        alert('èŠå¤©å®¤ä»£ç å¿…é¡»æ˜¯6ä½æ•°å­—');
        input.value = currentChatroomCode;
        return;
    }
    
    // æ›´æ–°èŠå¤©å®¤ä»£ç 
    const oldCode = currentChatroomCode;
    currentChatroomCode = code;
    input.value = code;
    
    console.log('ğŸ“¡ åˆ‡æ¢èŠå¤©å®¤ä»£ç :', oldCode, '->', currentChatroomCode);
    
    // æ›´æ–°èŠå¤©è¾“å…¥æ¡†æç¤º
    updateChatInputPlaceholder();
    
    // â­ é‡è¦ï¼šé‡æ–°è¿‡æ»¤æ‰€æœ‰æ¶ˆæ¯
    refilterAllMessages();
    
    // æ˜¾ç¤ºé€šçŸ¥
    if (code === "000000") {
        showNotification('å·²é€€å‡ºèŠå¤©å®¤ï¼Œå½“å‰ä¸ºå…¬å±æ¨¡å¼');
    } else {
        showNotification('å·²è¿›å…¥èŠå¤©å®¤ [' + code + ']');
    }
}

// â­ æ–°å¢ï¼šé‡æ–°è¿‡æ»¤æ‰€æœ‰æ¶ˆæ¯
// â­ æ–°å¢ï¼šé‡æ–°è¿‡æ»¤æ‰€æœ‰æ¶ˆæ¯
function refilterAllMessages() {
    console.log('ğŸ”„ é‡æ–°è¿‡æ»¤æ‰€æœ‰æ¶ˆæ¯ï¼Œå½“å‰èŠå¤©å®¤:', currentChatroomCode);
    
    if (chatMessages.length === 0) {
        console.log('ğŸ” æ²¡æœ‰æ¶ˆæ¯éœ€è¦é‡æ–°è¿‡æ»¤');
        updateChatMessages();
        showNetworkStatus(`å·²åˆ‡æ¢åˆ°èŠå¤©å®¤ ${currentChatroomCode}`, 2000);
        return;
    }
    
    // å¤‡ä»½æ‰€æœ‰æ¶ˆæ¯
    const allMessagesBackup = [...chatMessages];
    
    // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯
    chatMessages = [];
    
    // é‡æ–°æ·»åŠ æ‰€æœ‰æ¶ˆæ¯ï¼ˆä¼šè‡ªåŠ¨è¿‡æ»¤ï¼‰
    let keptCount = 0;
    let filteredCount = 0;
    
    allMessagesBackup.forEach(msg => {
        // ç³»ç»Ÿæ¶ˆæ¯å§‹ç»ˆæ·»åŠ 
        if (msg.isSystem) {
            chatMessages.push(msg);
            keptCount++;
            return;
        }
        
        // é‡æ–°åº”ç”¨è¿‡æ»¤é€»è¾‘
        const text = msg.text || '';
        const prefixMatch = text.match(/^\[(\d{6})\]\s+/);
        
        if (prefixMatch) {
            const messageRoomCode = prefixMatch[1];
            const actualContent = text.substring(prefixMatch[0].length).trim();
            
            // â­ ä¿®å¤ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æœ‰å®é™…å†…å®¹
            if (!actualContent) {
                filteredCount++;
                console.log('âš ï¸ è¿‡æ»¤åªæœ‰å‰ç¼€æ— å†…å®¹çš„æ¶ˆæ¯:', text);
                return;
            }
            
            if (currentChatroomCode === '000000') {
                // å…¬å±æ¨¡å¼ï¼šåªæ˜¾ç¤º[000000]çš„æ¶ˆæ¯
                if (messageRoomCode === '000000') {
                    chatMessages.push(msg);
                    keptCount++;
                } else {
                    filteredCount++;
                }
            } else {
                // èŠå¤©å®¤æ¨¡å¼ï¼šæ˜¾ç¤º[000000]æˆ–å½“å‰èŠå¤©å®¤çš„æ¶ˆæ¯
                if (messageRoomCode === '000000' || messageRoomCode === currentChatroomCode) {
                    chatMessages.push(msg);
                    keptCount++;
                } else {
                    filteredCount++;
                }
            }
        } else {
            // æ— å‰ç¼€æ¶ˆæ¯è¿‡æ»¤æ‰
            filteredCount++;
        }
    });
    
    console.log(`ğŸ” é‡æ–°è¿‡æ»¤å®Œæˆ: ä¿ç•™${keptCount}æ¡ï¼Œè¿‡æ»¤${filteredCount}æ¡`);
    
    // æ›´æ–°UI
    updateChatMessages();
    showNetworkStatus(`å·²åˆ‡æ¢åˆ°èŠå¤©å®¤ ${currentChatroomCode}ï¼Œæ˜¾ç¤º${keptCount}æ¡æ¶ˆæ¯`, 2000);
}
/**
 * é‡ç½®èŠå¤©å®¤ä»£ç åˆ°000000ï¼ˆå…¬å±æ¨¡å¼ï¼‰
 */
function resetChatroomCode() {
    const input = document.getElementById('chatroomCodeInput');
    if (input) {
        input.value = "000000";
        updateChatroomCode();
    }
}

/**
 * è®¾ç½®èŠå¤©å®¤ä»£ç ï¼ˆç‚¹å‡»å»ºç¾¤æ°”æ³¡æ—¶è°ƒç”¨ï¼‰
 * @param {string} code - èŠå¤©å®¤ä»£ç 
 */
function setChatroomCode(code) {
    const input = document.getElementById('chatroomCodeInput');
    if (input) {
        input.value = code;
        updateChatroomCode();
    }
}

/**
 * æ›´æ–°èŠå¤©è¾“å…¥æ¡†çš„æç¤ºæ–‡å­—
 * æ ¹æ®å½“å‰èŠå¤©å®¤çŠ¶æ€æ˜¾ç¤ºä¸åŒæç¤º
 */
function updateChatInputPlaceholder() {
    const chatInput = document.getElementById('chatInput');
    if (!chatInput) return;
    
    if (currentChatroomCode === "000000") {
        chatInput.placeholder = "è¾“å…¥å…¬å±æ¶ˆæ¯...";
        chatInput.value = "";  // æ¸…ç©ºè¾“å…¥æ¡†
    } else {
        chatInput.placeholder = "è¾“å…¥æ¶ˆæ¯ï¼ˆè‡ªåŠ¨æ·»åŠ [" + currentChatroomCode + "]å‰ç¼€ï¼Œå¯åˆ é™¤ä»¥å‘å…¬å±ï¼‰";
        // è‡ªåŠ¨æ·»åŠ å‰ç¼€
        if (!chatInput.value.startsWith('[' + currentChatroomCode + '] ')) {
            chatInput.value = '[' + currentChatroomCode + '] ';
        }
    }
}

function showNotification(message) {
    console.log('ğŸ“¢', message);
    
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(52, 152, 219, 0.95);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideDown 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åæ·¡å‡ºå¹¶ç§»é™¤
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}




// ==================== åœ¨JavaScriptä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•° ====================

// é¢æ¿çŠ¶æ€ç®¡ç†
let activeBottomButton = null;

// åˆ‡æ¢æ°”æ³¡åˆ—è¡¨é¢æ¿ï¼ˆæ§åˆ¶å³ä¾§é¢æ¿ï¼‰

// ==================== åªä¿®å¤æ°”æ³¡åˆ—è¡¨æŒ‰é’®é€»è¾‘ ====================

// åˆ‡æ¢æ°”æ³¡åˆ—è¡¨é¢æ¿ï¼ˆæ§åˆ¶å³ä¾§é¢æ¿ï¼‰
function toggleBubbleListPanel() {
    const panel = document.getElementById('controlPanel');
    const mapContainer = document.getElementById('mapContainer');
    const bubbleBtn = document.querySelector('.bottom-btn:nth-child(1)');
    const chatBtn = document.querySelector('.bottom-btn:nth-child(2)');
    
    panelCollapsed = !panelCollapsed;
    
    if (panelCollapsed) {
        // é¢æ¿æ”¶èµ·æ—¶
        panel.classList.add('collapsed');
        mapContainer.classList.add('full-width');
        bubbleBtn.classList.remove('active'); // é¢æ¿æ”¶èµ·æ—¶ï¼ŒæŒ‰é’®ä¸åº”è¯¥é«˜äº®
        activeBottomButton = null;
    } else {
        // é¢æ¿å±•å¼€æ—¶
        panel.classList.remove('collapsed');
        mapContainer.classList.remove('full-width');
        bubbleBtn.classList.add('active'); // é¢æ¿å±•å¼€æ—¶ï¼ŒæŒ‰é’®åº”è¯¥é«˜äº®
        chatBtn.classList.remove('active'); // ç¡®ä¿èŠå¤©æŒ‰é’®ä¸é«˜äº®
        activeBottomButton = 'bubbleList';
    }
    
    // å…³é—­å…¶ä»–é¢æ¿ä½†ä¿æŒæŒ‰é’®çŠ¶æ€
    // ä¸è¦åœ¨è¿™é‡Œè°ƒç”¨ closeChatPanel()ï¼Œå› ä¸ºé‚£ä¼šå½±å“èŠå¤©æŒ‰é’®
    // ç›´æ¥å…³é—­èŠå¤©é¢æ¿ä½†ä¸å½±å“æŒ‰é’®
    const chatPanel = document.getElementById('chatPanel');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    if (chatPanel) {
        chatPanel.style.display = 'none';
    }
    if (chatToggleBtn) {
        chatToggleBtn.style.display = 'flex';
    }
    
    // éšè—å‘å¸ƒé¢æ¿ä½†ä¸å½±å“æŒ‰é’®
    const publishPanel = document.getElementById('publishPanel');
    if (publishPanel) {
        publishPanel.style.display = 'none';
    }
    
    console.log("æ°”æ³¡åˆ—è¡¨é¢æ¿:", panelCollapsed ? "æ”¶èµ·" : "å±•å¼€", "æ°”æ³¡æŒ‰é’®é«˜äº®:", !panelCollapsed);
}


// åˆ‡æ¢èŠå¤©é¢æ¿ï¼ˆæ§åˆ¶åº•éƒ¨èŠå¤©é¢æ¿ï¼‰
function toggleChatPanel() {
    const panel = document.getElementById('chatPanel');
    const chatBtn = document.querySelector('.bottom-btn:nth-child(2)');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    
    if (panel.style.display === 'flex') {
        panel.style.display = 'none';
        chatToggleBtn.style.display = 'flex';
        chatBtn.classList.remove('active');
        if (activeBottomButton === 'chat') activeBottomButton = null;
    } else {
        panel.style.display = 'flex';
        chatToggleBtn.style.display = 'none';
        chatBtn.classList.add('active');
        activeBottomButton = 'chat';
        
        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.focus();
        }, 100);
    }
    
    // å…³é—­å…¶ä»–é¢æ¿
    collapseControlPanel();
    hidePublishPanel();
    updateOtherButtons(chatBtn);
}



// éšè—å‘å¸ƒæ°”æ³¡é¢æ¿
function hidePublishPanel() {
    const publishPanel = document.getElementById('publishPanel');
    const publishBtn = document.querySelector('.bottom-btn:nth-child(3)');
    
    publishPanel.style.display = 'none';
    publishBtn.classList.remove('active');
    if (activeBottomButton === 'publish') activeBottomButton = null;
}

// ä»å‘å¸ƒé¢æ¿å‘å¸ƒæ°”æ³¡
function publishBubbleFromPanel() {
    const title = document.getElementById('bubbleTitlePanel').value.trim();
    const content = document.getElementById('bubbleContentPanel').value.trim();
    
    if (!title) {
        showNetworkStatus("è¯·è¾“å…¥æ°”æ³¡æ ‡é¢˜", 2000);
        return;
    }
    
    if (!currentUser) {
        showNetworkStatus("è¯·å…ˆç™»å½•", 2000);
        return;
    }
    
    // ä½¿ç”¨å½“å‰é€‰æ‹©çš„ä½ç½®
    const publishPosition = myPosition;
    
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: "publishBubble",
            bubbleType: selectedBubbleType,
            roomCode: selectedBubbleType === 'group' ? generateChatroomCode() : null,
            title: title,
            content: content,
            lat: publishPosition.lat,
            lng: publishPosition.lng,
            duration: 3600,
            activityTags: []
        }));
        
        console.log("ğŸ“¤ ä»é¢æ¿å‘å¸ƒæ°”æ³¡:", {title, type: selectedBubbleType});
        showNetworkStatus("æ°”æ³¡å‘å¸ƒæˆåŠŸï¼", 2000);
    }
    
    // æ¸…ç©ºè¡¨å•å¹¶å…³é—­é¢æ¿
    document.getElementById('bubbleTitlePanel').value = '';
    document.getElementById('bubbleContentPanel').value = '';
    hidePublishPanel();
}

// æ›´æ–°å‘å¸ƒé¢æ¿çš„ä½ç½®æ˜¾ç¤º
function updatePublishPanelLocationDisplay() {
    const element = document.getElementById('publishLocationTextPanel');
    if (element && myPosition) {
        const modeText = locationMode === 'gps' ? 'GPSå®šä½' : 'æ‰‹åŠ¨é€‰æ‹©';
        element.textContent = `ğŸ“ ${modeText} (${myPosition.lat.toFixed(4)}, ${myPosition.lng.toFixed(4)})`;
    }
}

// è¾…åŠ©å‡½æ•°ï¼šæ”¶èµ·æ§åˆ¶é¢æ¿
function collapseControlPanel() {
    const panel = document.getElementById('controlPanel');
    const mapContainer = document.getElementById('mapContainer');

    panelCollapsed = true;
    panel.classList.add('collapsed');
    mapContainer.classList.add('full-width');
    toggleBtn.textContent = 'å±•å¼€é¢æ¿';
    
    // æ›´æ–°åº•éƒ¨æŒ‰é’®çŠ¶æ€
    const bubbleBtn = document.querySelector('.bottom-btn:nth-child(1)');
    bubbleBtn.classList.remove('active');
}

// è¾…åŠ©å‡½æ•°ï¼šå…³é—­èŠå¤©é¢æ¿
function closeChatPanel() {
    const panel = document.getElementById('chatPanel');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatBtn = document.querySelector('.bottom-btn:nth-child(2)');
    
    panel.style.display = 'none';
    chatToggleBtn.style.display = 'flex';
    chatBtn.classList.remove('active');
}

// è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å…¶ä»–æŒ‰é’®çŠ¶æ€
function updateOtherButtons(activeButton) {
    const buttons = document.querySelectorAll('.bottom-btn');
    buttons.forEach(btn => {
        if (btn !== activeButton) {
            btn.classList.remove('active');
        }
    });
}

// æ›´æ–°å·²æœ‰çš„ä½ç½®æ›´æ–°å‡½æ•°
function updatePublishLocationDisplay() {
    const element = document.getElementById('publishLocationText');
    if (element && myPosition) {
        const modeText = locationMode === 'gps' ? 'GPSå®šä½' : 'æ‰‹åŠ¨é€‰æ‹©';
        element.textContent = `ğŸ“ ${modeText} (${myPosition.lat.toFixed(4)}, ${myPosition.lng.toFixed(4)})`;
    }
    
    // åŒæ—¶æ›´æ–°å‘å¸ƒé¢æ¿çš„ä½ç½®æ˜¾ç¤º
    updatePublishPanelLocationDisplay();
}

// ä¿®æ”¹ç°æœ‰çš„å‘å¸ƒæ°”æ³¡è¡¨å•å‡½æ•°
function publishBubble() {
    const title = document.getElementById('bubbleTitle').value.trim();
    const content = document.getElementById('bubbleContent').value.trim();
    
    if (!title) {
        showNetworkStatus("è¯·è¾“å…¥æ°”æ³¡æ ‡é¢˜", 2000);
        return;
    }
    
    if (!currentUser) {
        showNetworkStatus("è¯·å…ˆç™»å½•", 2000);
        return;
    }
    
    // ä½¿ç”¨å½“å‰é€‰æ‹©çš„ä½ç½®
    const publishPosition = myPosition;
    
    // â­ å…³é”®ï¼šç”Ÿæˆæˆ¿é—´ä»£ç 
    const roomCode = selectedBubbleType === 'group' ? generateChatroomCode() : null;
    
    console.log("ğŸ“¤ å‘å¸ƒå»ºç¾¤æ°”æ³¡ï¼Œæˆ¿é—´ä»£ç :", roomCode);
    
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: "publishBubble",
            bubbleType: selectedBubbleType,
            roomCode: roomCode,  // â­ å‘é€æˆ¿é—´ä»£ç 
            title: title,
            content: content,
            lat: publishPosition.lat,
            lng: publishPosition.lng,
            duration: 3600,
            activityTags: []
        }));
        
        console.log("ğŸ“¤ å‘é€æ°”æ³¡(publishBubble):", {title, type: selectedBubbleType, roomCode});
        showNetworkStatus(`æ°”æ³¡å‘å¸ƒæˆåŠŸ${roomCode ? 'ï¼Œæˆ¿é—´ä»£ç : ' + roomCode : ''}ï¼`, 3000);
    }
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('bubbleTitle').value = '';
    document.getElementById('bubbleContent').value = '';
}


    // é¡µé¢å…³é—­æ—¶æ¸…ç†
    window.onbeforeunload = function() {
        stopAutoRefresh();
        if (socket) socket.close();
    };



// ==================== é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– ====================

</script>

    <!-- åœ¨chat-panelä¹‹åï¼Œåº•éƒ¨æ ä¹‹å‰æ·»åŠ å‘å¸ƒæ°”æ³¡é¢æ¿ -->
<div class="publish-panel" id="publishPanel">
    <div class="publish-panel-header">
        <span>â• å‘å¸ƒæ–°æ°”æ³¡</span>
        <button onclick="hidePublishPanel()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
    </div>
    <div class="publish-panel-content">
        <div class="bubble-types">
            <button class="bubble-type-btn" data-type="recommend" onclick="selectBubbleType('recommend')">ğŸ‘ æ¨è</button>
            <button class="bubble-type-btn" data-type="help" onclick="selectBubbleType('help')">ğŸ†˜ æ±‚åŠ©</button>
            <button class="bubble-type-btn" data-type="team" onclick="selectBubbleType('team')">ğŸ‘¥ ç»„é˜Ÿ</button>
            <button class="bubble-type-btn" data-type="group" onclick="selectBubbleType('group')">ğŸ’¬ å»ºç¾¤</button>
            <button class="bubble-type-btn" data-type="warning" onclick="selectBubbleType('warning')">é¿é›·</button>
            <button class="bubble-type-btn" data-type="news" onclick="selectBubbleType('news')">è§é—»</button>
        </div>
        <input type="text" id="bubbleTitlePanel" placeholder="æ°”æ³¡æ ‡é¢˜" style="margin-top: 15px;">
        <textarea id="bubbleContentPanel" placeholder="æ°”æ³¡å†…å®¹ï¼ˆå¯é€‰ï¼‰" style="margin-top: 10px; min-height: 100px;"></textarea>
        <div style="margin: 12px 0; font-size: 13px; color: #052659;">
            å‘å¸ƒä½ç½®: <span id="publishLocationTextPanel">ğŸ“ ä½¿ç”¨å½“å‰ä½ç½®</span>
        </div>
        <button class="publish-btn" onclick="publishBubbleFromPanel()" style="margin-top: 10px;">å‘å¸ƒæ°”æ³¡</button>
    </div>
</div>
<!-- ä¿®æ”¹åº•éƒ¨æ æŒ‰é’®çš„onclickäº‹ä»¶ -->
<div class="bottom-bar">
    <button class="bottom-btn" onclick="toggleBubbleListPanel()">
        ğŸ«§
    </button>
    <button class="bottom-btn" onclick="toggleChatPanel()">
        ğŸ’¬
    </button>

    <!-- èŠå¤©å®¤ä»£ç è¾“å…¥åŒºåŸŸä¿æŒä¸å˜ -->
    <div style="display: flex; align-items: center; gap: 8px; margin-left: 15px; padding: 0 10px;">
        <span style="font-size: 12px; color: rgba(255,255,255,0.9);">èŠå¤©å®¤:</span>
        <input type="text" 
               id="chatroomCodeInput" 
               value="000000"
               maxlength="6"
               placeholder="000000"
               style="width: 65px; 
                      padding: 6px 8px; 
                      border-radius: 6px; 
                      border: 1px solid rgba(255,255,255,0.3); 
                      background: rgba(255,255,255,0.15); 
                      color: white; 
                      text-align: center;
                      font-size: 12px;
                      outline: none;"
               onchange="updateChatroomCode()"
               onkeypress="if(event.key === 'Enter') updateChatroomCode()">
        <button class="bottom-btn" 
                onclick="resetChatroomCode()" 
                style="padding: 6px 10px; background: rgba(255,255,255,0.2); font-size: 12px;">
            å…¬å±
        </button>
    </div>
</div>

</body>
</html>